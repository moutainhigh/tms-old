Ext.ns("uft.cm");uft.cm.BuildReceCheckSheet=function(a){Ext.apply(this,a);if(!this.records){uft.Utils.showErrorMsg("请先选择要对账的记录！");return false;}var e=0;for(var d=0;d<this.records.length;d++){e+=uft.Utils.getNumberColumnValue(this.records[d],"cost_amount");}var b=new Date();var h=b.getFullYear();var g=b.getMonth()+1;var j=[];for(var d=h-5;d<h+5;d++){j.push([d,d]);}var c=new Ext.data.ArrayStore({fields:["text","value"],data:j});var f=new Ext.data.ArrayStore({fields:["text","value"],data:[[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9],[10,10],[11,11],[12,12]]});this.formPanel=new uft.extend.form.FormPanel({labelWidth:60,border:false,items:[{layout:"tableform",layoutConfig:{columns:2},border:false,padding:"5px 5px 0",defaults:{anchor:"95%",xtype:"textfield"},items:[{name:"cost_amount_1",fieldLabel:"总金额",xtype:"uftnumberfield",readOnly:true,decimalPrecision:2,value:e,colspan:1},{xtype:"localcombo",name:"year",fieldLabel:"对账年份",store:c,value:h,colspan:1,newlineflag:true},{xtype:"localcombo",name:"month",fieldLabel:"对账月份",store:f,value:g,colspan:1,newlineflag:true},{name:"memo",fieldLabel:"备注",colspan:2}]}]});uft.cm.BuildReceCheckSheet.superclass.constructor.call(this,{title:"生成对账单",width:500,height:300,collapsible:false,frame:true,closable:true,draggable:true,resizable:true,modal:true,border:false,layout:"fit",items:[this.formPanel],buttons:[{iconCls:"btnYes",text:"保&nbsp;&nbsp;存",actiontype:"submit",scope:this,handler:this.saveAction},{iconCls:"btnCancel",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.destroy();}}]});};Ext.extend(uft.cm.BuildReceCheckSheet,Ext.Window,{saveAction:function(){var d=this.formPanel.getForm();if(d.isValid()){var b=d.getFieldValues(false);var a=[];for(var c=0;c<this.records.length;c++){var e=this.records[c].data;Ext.apply(e,b);a.push(e);}var f=this.app.newAjaxParams();f[uft.jf.Constants.HEADER]=Ext.encode(a);uft.Utils.doAjax({scope:this,params:f,isTip:false,url:"buildReceCheckSheet.json",success:function(g){if(g){if(g.datas){this.app._setHeaderValues(this.records,g.datas);this.app.statusMgr.setBizStatus(g.datas[0][this.app.getBillStatusField()]);this.app.statusMgr.updateStatus();}this.destroy();}}});}}});Ext.ns("uft.cm");uft.cm.Receivable=function(b){Ext.apply(this,b);if(!this.record){uft.Utils.showErrorMsg("请先选择要收款的记录！");return false;}var a=Utils.doSyncRequest(ctxPath+"/cm/rd/getCheckHead.json",{bala_customer:this.record.data.bala_customer});var c=a.checkHead;this.formPanel=new uft.extend.form.FormPanel({labelWidth:60,border:false,items:[{layout:"tableform",layoutConfig:{columns:2},border:false,padding:"5px 5px 0",defaults:{anchor:"95%",xtype:"textfield"},items:[{name:"receivable_amount",fieldLabel:"收款金额",value:this.record.data.ungot_amount,xtype:"uftnumberfield",allowBlank:false,itemCls:"uft-form-label-not-null",decimalPrecision:2,colspan:1},{xtype:"uftdatefield",name:"receivable_date",fieldLabel:"收款日期",allowBlank:false,itemCls:"uft-form-label-not-null",value:DateUtils.formatDate(new Date(),"yyyy-MM-dd"),colspan:1},{refName:"用户档案-web",xtype:"headerreffield",id:"receivable_man",name:"receivable_man",fieldLabel:"收款人",colspan:1,refWindow:{model:1,leafflag:false,params:"refName:'用户档案-web'",gridDataUrl:ctxPath+"/ref/common/user/load4Grid.json",extGridColumnDescns:[{type:"string",width:120,dataIndex:"pk_user",sortable:true,xtype:"gridcolumn",hidden:true},{header:"用户编码",type:"string",width:120,dataIndex:"user_code",xtype:"gridcolumn"},{header:"用户名称",type:"string",width:120,dataIndex:"user_name",xtype:"gridcolumn"},{header:"用户备注",type:"string",width:120,dataIndex:"user_note",xtype:"gridcolumn"},{header:"用户类型",type:"string",width:120,dataIndex:"user_type",xtype:"gridcolumn"}]},pkField:"pk_user",codeField:"user_code",nameField:"user_name",showCodeOnBlur:false,getByPkUrl:ctxPath+"/ref/common/user/getByPk.do",getByCodeUrl:ctxPath+"/ref/common/user/getByCode.do"},{name:"check_no",fieldLabel:"发票号",colspan:1},{name:"check_head",fieldLabel:"发票抬头",value:c,colspan:1},{xtype:"uftcombo",name:"receivable_method",fieldLabel:"收款方式",itemCls:"uft-form-label-not-null",allowBlank:false,dataUrl:ctxPath+"/cm/rd/getReceivableMethod.json",colspan:1},{name:"memo",fieldLabel:"收款备注",colspan:2}]}]});uft.cm.Receivable.superclass.constructor.call(this,{title:"收款",width:500,height:300,collapsible:false,frame:true,closable:true,draggable:true,resizable:true,modal:true,border:false,layout:"fit",items:[this.formPanel],buttons:[{iconCls:"btnYes",text:"保&nbsp;&nbsp;存",actiontype:"submit",scope:this,handler:this.saveAction},{iconCls:"btnCancel",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.destroy();}}]});};Ext.extend(uft.cm.Receivable,Ext.Window,{saveAction:function(){var c=this.record.data.pk_receive_detail;var a=this.record.data.vbillno;var d=this.formPanel.getForm();var f=this.formPanel.getErrors();if(f.length==0){var b=d.getFieldValues(false);Ext.apply(b,{relationid:c,vbillno:a});var e=this.app.newAjaxParams();e[uft.jf.Constants.HEADER]=Ext.encode(b);uft.Utils.doAjax({scope:this,params:e,isTip:false,url:"receivable.json",success:function(g){if(g){if(g.datas){this.app._setHeaderValues([this.record],g.datas);this.app.statusMgr.setBizStatus(g.datas[0][this.app.getBillStatusField()]);this.app.statusMgr.updateStatus();}this.destroy();}}});}else{uft.Utils.showWarnMsg(Utils.arrayToString(f,""));return;}}});Ext.ns("uft.cm");uft.cm.ReceRecord=function(c){Ext.apply(this,c);if(!this.record){uft.Utils.showErrorMsg("请先选择记录！");return false;}var b=Utils.doSyncRequest("getTempletMap.json",{funCode:"t480",tabCode:"ts_rece_record"},"POST");if(!b||!b.data){uft.Utils.showErrorMsg("没有模板数据，funCode：t480,tabcode:ts_rece_record！");return false;}var d=b.data.records;var f=b.data.columns;var e=b.data.params;e.isBody="true";e.pk_receive_detail=this.record.data.pk_receive_detail;this.grid=new uft.extend.grid.BasicGrid({id:"ts_rece_record_1",pkFieldName:"pk_rece_record",dataUrl:"loadReceRecord.json",immediatelyLoad:true,isCheckboxSelectionModel:false,params:e,recordType:d,columns:f});uft.cm.ReceRecord.superclass.constructor.call(this,{title:"收款记录",width:800,height:500,collapsible:false,frame:true,closable:true,draggable:true,resizable:true,modal:true,border:false,layout:"fit",items:[this.grid],buttons:[{iconCls:"btnCancel",text:"关&nbsp;&nbsp;闭",scope:this,handler:function(){this.destroy();}}]});var a=uft.Utils.getColumn(this.grid,"_processor");if(a){a.renderer=function(){return"<div align='center'><a href='javascript:deleteReceRecord();'>删除</a></div>";};}};Ext.extend(uft.cm.ReceRecord,Ext.Window,{});function deleteReceRecord(){var d=Ext.getCmp("ts_rece_record_1");if(d){var c=uft.Utils.getSelectedRecord(d);var a=c.data.receivable_type;if(a==1){uft.Utils.showWarnMsg("不能删除收款类型是对账收款的记录!");return;}var b=c.data.pk_rece_record;var e=this.app.newAjaxParams();e.pk_rece_record=b;uft.Utils.doAjax({scope:this,params:e,isTip:false,url:"deleteReceRecord.json",success:function(h){if(h){d.getStore().remove(c);if(h.datas){var f=app.getHeaderGrid();var g=uft.Utils.getSelectedRecord(f);app._setHeaderValues([g],h.datas);this.app.statusMgr.setBizStatus(h.datas[0][this.app.getBillStatusField()]);this.app.statusMgr.updateStatus();}}}});}}Ext.ns("uft.cm");uft.cm.AddToReceCheckSheet=function(b){Ext.apply(this,b);if(!this.records){uft.Utils.showErrorMsg("请先选择要加入对账单的记录！");return false;}var a=Utils.doSyncRequest("getTempletMap.json",{funCode:"t405",tabCode:"ts_rece_check_sheet"},"POST");if(!a||!a.data){uft.Utils.showErrorMsg("没有模板数据，funCode：t405！");return false;}var c=a.data.records;var e=a.data.columns;var d=a.data.params;var f=this.records[0].data.bala_customer;d.bala_customer=f;this.grid=new uft.extend.grid.BasicGrid({pkFieldName:"pk_rece_check_sheet",dataUrl:"loadReceCheckSheet.json",params:d,singleSelect:true,isCheckboxSelectionModel:false,isAddBbar:false,immediatelyLoad:true,recordType:c,columns:e});uft.cm.AddToReceCheckSheet.superclass.constructor.call(this,{title:"加入对账单",width:800,height:500,collapsible:false,frame:true,closable:true,draggable:true,resizable:true,modal:true,border:false,layout:"fit",items:[this.grid],buttons:[{iconCls:"btnYes",text:"保&nbsp;&nbsp;存",scope:this,handler:function(){this.saveAction();}},{iconCls:"btnCancel",text:"关&nbsp;&nbsp;闭",scope:this,handler:function(){this.destroy();}}]});};Ext.extend(uft.cm.AddToReceCheckSheet,Ext.Window,{saveAction:function(){var b=uft.Utils.getSelectedRecord(this.grid);if(!b){uft.Utils.showErrorMsg("请选择记录！");return false;}var f=b.data.bala_customer;var e=this.app.newAjaxParams(),c=[],a;for(var d=0;d<this.records.length;d++){c.push(this.records[d].data.pk_receive_detail);a=this.records[d].data.bala_customer;}if(f!=a){uft.Utils.showErrorMsg("您必须选择结算客户为["+f+"]的记录！");return false;}e.pk_receive_detail=c;e.pk_rece_check_sheet=b.data.pk_rece_check_sheet;uft.Utils.doAjax({scope:this,params:e,isTip:false,url:"addToReceCheckSheet.json",success:function(g){if(g){if(g.datas){this.app._setHeaderValues(this.records,g.datas);this.app.statusMgr.setBizStatus(g.datas[0][this.app.getBillStatusField()]);this.app.statusMgr.updateStatus();}this.destroy();}}});}});