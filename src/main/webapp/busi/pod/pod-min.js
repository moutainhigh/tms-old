Ext.ns("uft.pod");uft.pod.POD=function(a){Ext.apply(this,a);if(!this.records){uft.Utils.showErrorMsg("请先选择要签收的记录！");return false;}this.formPanel=new uft.extend.form.FormPanel({labelWidth:60,border:false,items:[{layout:"tableform",layoutConfig:{columns:2},border:false,padding:"5px 5px 0",defaults:{anchor:"95%",xtype:"textfield"},items:[{name:"pod_man",fieldLabel:"签收人",allowBlank:false,itemCls:"uft-form-label-not-null",colspan:1},{xtype:"datetimefield",name:"pod_date",fieldLabel:"签收日期",allowBlank:false,itemCls:"uft-form-label-not-null",value:DateUtils.formatDate(new Date(),"yyyy-MM-dd H:m:s"),newlineflag:true,colspan:1},{name:"pod_memo",fieldLabel:"签收备注",colspan:2}]}]});uft.pod.POD.superclass.constructor.call(this,{title:"签收",width:500,height:300,collapsible:false,frame:true,closable:true,draggable:true,resizable:true,modal:true,border:false,layout:"fit",items:[this.formPanel],buttons:[{iconCls:"btnYes",text:"保&nbsp;&nbsp;存",actiontype:"submit",scope:this,handler:this.saveAction},{iconCls:"btnCancel",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.destroy();}}]});};Ext.extend(uft.pod.POD,Ext.Window,{saveAction:function(){var d=this.formPanel.getForm();var f=this.formPanel.getErrors();if(f.length!=0){uft.Utils.showWarnMsg(Utils.arrayToString(f,""));return;}var e=this.app.newAjaxParams(),b=[];for(var c=0;c<this.records.length;c++){b.push(this.records[c].data.pk_invoice);}e.pk_invoice=b;var a=d.getFieldValues(false);Ext.apply(e,a);uft.Utils.doAjax({scope:this,params:e,url:"pod.json",success:function(g){if(g&&g.datas){for(var h=0;h<g.datas.length;h++){this.app.setAppValues(g.datas[h],{updateToHeaderGrid:true,updateRecord:this.records[h],saveToCache:true,updateBody:false});}if(typeof(this.app.getBillStatusField)=="function"){this.app.statusMgr.setBizStatus(g.datas[0].HEADER[this.app.getBillStatusField()]);}this.app.statusMgr.updateStatus();}this.destroy();}});}});Ext.ns("uft.pod");uft.pod.PODExp=function(b){Ext.apply(this,b);if(!this.record){uft.Utils.showErrorMsg("请先选择要签收的记录！");return false;}this.formPanel=new uft.extend.form.FormPanel({region:"north",height:160,labelWidth:80,border:false,items:[{layout:"tableform",layoutConfig:{columns:3},border:false,padding:"5px 5px 0",defaults:{anchor:"95%",xtype:"textfield"},items:[{name:"pod_man",fieldLabel:"签收人",allowBlank:false,itemCls:"uft-form-label-not-null",colspan:1},{xtype:"uftdatefield",name:"pod_date",fieldLabel:"签收日期",allowBlank:false,itemCls:"uft-form-label-not-null",value:DateUtils.formatDate(new Date(),"yyyy-MM-dd"),colspan:1},{name:"pod_exp_type",fieldLabel:"异常类型",xtype:"multiselectfield",colspan:1,dataUrl:ctxPath+"/datadict/getDataDict4MultiSelect.json",baseParams:{datatype_code:"exp_accident_type"}},{name:"pod_memo",fieldLabel:"签收备注",colspan:2},{xtype:"uftnumberfield",decimalPrecision:0,name:"pod_num_count",fieldLabel:"签收件数",value:this.record.get("num_count"),readOnly:true,itemCls:"uft-grid-header-column-not-edit",newlineflag:true,colspan:1},{xtype:"uftnumberfield",decimalPrecision:0,name:"reject_num_count",fieldLabel:"拒签件数",readOnly:true,itemCls:"uft-grid-header-column-not-edit",colspan:1},{xtype:"uftnumberfield",decimalPrecision:0,name:"damage_num_count",fieldLabel:"破损件数",readOnly:true,itemCls:"uft-grid-header-column-not-edit",colspan:1},{xtype:"uftnumberfield",decimalPrecision:0,name:"lost_num_count",fieldLabel:"丢失件数",readOnly:true,itemCls:"uft-grid-header-column-not-edit",colspan:1},{xtype:"uftnumberfield",decimalPrecision:2,name:"pod_weight_count",id:"_pod_weight_count",fieldLabel:"签收重量",value:this.record.get("weight_count"),colspan:1},{xtype:"uftnumberfield",decimalPrecision:2,name:"pod_volume_count",id:"_pod_volume_count",fieldLabel:"签收体积",value:this.record.get("volume_count"),colspan:1},{xtype:"uftnumberfield",decimalPrecision:2,name:"pod_volume_weight_count",id:"_pod_volume_weight_count",fieldLabel:"签收体积重",value:this.record.get("volume_weight_count"),readOnly:true,itemCls:"uft-grid-header-column-not-edit",colspan:1},{xtype:"uftnumberfield",decimalPrecision:2,name:"pod_fee_weight_count",id:"_pod_fee_weight_count",fieldLabel:"签收计费重",value:this.record.get("fee_weight_count"),colspan:1},{xtype:"uftcheckbox",name:"update_rece_detail",fieldLabel:"更新应收明细",colspan:1}]}]});this.formPanel.getForm().items.each(function(f){f.on("change",function(i,h,g){if(i.name=="pod_weight_count"){this.compute();}else{if(i.name=="pod_volume_count"){this.compute();}}},this);},this);var a=Utils.doSyncRequest("getTempletMap.json",{funCode:"t601",tabCode:"ts_inv_pack_b"},"POST");if(!a||!a.data){uft.Utils.showErrorMsg("没有模板数据，funCode：t601,tabcode:ts_inv_pack_b！");return false;}var c=a.data.records;var e=a.data.columns;var d=a.data.params;d.isBody="true";d.pk_invoice=this.record.data.pk_invoice;d.fromExp=true;this.grid=new uft.extend.grid.EditorGrid({region:"center",id:"ts_inv_pack_b_1",pkFieldName:"pk_inv_pack_b",dataUrl:"loadData.json",immediatelyLoad:true,isCheckboxSelectionModel:false,isAddBbar:false,params:d,recordType:c,columns:e});this.grid.on("afteredit",function(f){this.checkAfterEditNum(f.record,f.field);},this);uft.pod.PODExp.superclass.constructor.call(this,{title:"异常签收",width:800,height:500,collapsible:false,frame:true,closable:true,draggable:true,resizable:true,modal:true,border:false,layout:"border",items:[this.formPanel,this.grid],buttons:[{iconCls:"btnYes",text:"保&nbsp;&nbsp;存",actiontype:"submit",scope:this,handler:this.saveAction},{iconCls:"btnCancel",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.destroy();}}]});};Ext.extend(uft.pod.PODExp,Ext.Window,{compute:function(){if(this.transTypeFeeMap){this._compute();}else{uft.Utils.doAjax({scope:this,isTip:false,url:ctxPath+"/inv/inv/getTransTypeRateMap.json",success:function(a){if(a.data){this.transTypeFeeMap=a.data;this._compute();}}});}},_compute:function(){var e=this.record.get("pk_trans_type");var c=this.transTypeFeeMap[e];var f=uft.Utils.getField("_pod_volume_count").getValue();var d=uft.Utils.getField("_pod_weight_count").getValue();var b=f*c;uft.Utils.getField("_pod_volume_weight_count").setValue(b);var a=b;if(a<d){a=d;}uft.Utils.getField("_pod_fee_weight_count").setValue(a);},checkBeforeSave:function(){var d=this.grid.getStore();for(var g=0;g<d.getCount();g++){var b=d.getAt(g);var f=uft.Utils.getNumberColumnValue(b,"num");var c=uft.Utils.getNumberColumnValue(b,"pod_num");var a=uft.Utils.getNumberColumnValue(b,"reject_num");var e=uft.Utils.getNumberColumnValue(b,"damage_num");var h=uft.Utils.getNumberColumnValue(b,"lost_num");if(f!=(c+a+e+h)){uft.Utils.showWarnMsg("第"+(g+1)+"行签收件数+拒收件数+破损件数+丢失件数必须等于件数！");return false;}}},checkAfterEditNum:function(c,d){var g=uft.Utils.getGridSumValueMap("ts_inv_pack_b_1",["pod_num","reject_num","damage_num","lost_num"]);this.formPanel.getForm().items.each(function(i){var h=n=i.getName();if(h=="pod_num_count"||h=="reject_num_count"||h=="damage_num_count"||h=="lost_num_count"){i.setValue(g[h.substring(0,h.indexOf("_count"))]);}});if(d=="pod_num"){var b=uft.Utils.getNumberColumnValue(c,"unit_weight");var a=uft.Utils.getNumberColumnValue(c,"unit_volume");var f=uft.Utils.getNumberColumnValue(c,"pod_num");c.beginEdit();uft.Utils.setColumnValue(c,"weight",f*b);uft.Utils.setColumnValue(c,"volume",f*a);c.endEdit();var e=uft.Utils.getGridSumValueMap("ts_inv_pack_b_1",["num","weight","volume"]);uft.Utils.getField("_pod_weight_count").setValue(e.weight);uft.Utils.getField("_pod_volume_count").setValue(e.volume);this.compute();}},getAppParams:function(){var d=this.formPanel.getErrors();if(d.length!=0){uft.Utils.showWarnMsg(Utils.arrayToString(d,""));return null;}var a=this.formPanel.getForm();if(a.isValid()){var c={};values=a.getFieldValues(false);c[uft.jf.Constants.HEADER]=values;var b={};b.ts_inv_pack_b=this.grid.getModifyValue();c[uft.jf.Constants.BODY]=b;return c;}return null;},saveAction:function(){if(this.checkBeforeSave()===false){return;}var b=this.app.newAjaxParams();var a=this.getAppParams();if(!a){return;}b[uft.jf.Constants.APP_POST_DATA]=Ext.encode(a);b.pk_invoice=this.record.data.pk_invoice;uft.Utils.doAjax({scope:this,params:b,url:"expPod.json",success:function(c){if(c&&c.data){this.app.setAppValues(c.data,{updateToHeaderGrid:true,saveToCache:true,updateBody:false});if(typeof(this.app.getBillStatusField)=="function"){this.app.statusMgr.setBizStatus(c.data.HEADER[this.app.getBillStatusField()]);}this.app.statusMgr.updateStatus();}this.destroy();}});}});Ext.ns("uft.pod");uft.pod.Receipt=function(a){Ext.apply(this,a);if(!this.records){uft.Utils.showErrorMsg("请先选择要回单的记录！");return false;}this.formPanel=new uft.extend.form.FormPanel({labelWidth:60,border:false,items:[{layout:"tableform",layoutConfig:{columns:2},border:false,padding:"5px 5px 0",defaults:{anchor:"95%",xtype:"textfield"},items:[{name:"receipt_man",fieldLabel:"回单人",allowBlank:false,itemCls:"uft-form-label-not-null",colspan:1},{xtype:"uftdatefield",name:"act_receipt_date",fieldLabel:"回单日期",allowBlank:false,itemCls:"uft-form-label-not-null",value:DateUtils.formatDate(new Date(),"yyyy-MM-dd"),newlineflag:true,colspan:1},{name:"receipt_memo",fieldLabel:"回单备注",colspan:2}]}]});uft.pod.Receipt.superclass.constructor.call(this,{title:"回单",width:500,height:300,collapsible:false,frame:true,closable:true,draggable:true,resizable:true,modal:true,border:false,layout:"fit",items:[this.formPanel],buttons:[{iconCls:"btnYes",text:"保&nbsp;&nbsp;存",actiontype:"submit",scope:this,handler:this.saveAction},{iconCls:"btnCancel",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.destroy();}}]});};Ext.extend(uft.pod.Receipt,Ext.Window,{saveAction:function(){var d=this.formPanel.getForm();var f=this.formPanel.getErrors();if(f.length!=0){uft.Utils.showWarnMsg(Utils.arrayToString(f,""));return;}var e=this.app.newAjaxParams(),b=[];for(var c=0;c<this.records.length;c++){b.push(this.records[c].data.pk_invoice);}e.pk_invoice=b;var a=d.getFieldValues(false);Ext.apply(e,a);uft.Utils.doAjax({scope:this,params:e,url:"receipt.json",success:function(g){if(g&&g.datas){for(var h=0;h<g.datas.length;h++){this.app.setAppValues(g.datas[h],{updateToHeaderGrid:true,updateRecord:this.records[h],saveToCache:true,updateBody:false});}if(typeof(this.app.getBillStatusField)=="function"){this.app.statusMgr.setBizStatus(g.datas[0].HEADER[this.app.getBillStatusField()]);}this.app.statusMgr.updateStatus();}this.destroy();}});}});Ext.ns("uft.pod");uft.pod.ReceiptExp=function(a){Ext.apply(this,a);if(!this.record){uft.Utils.showErrorMsg("请先选择要回单的记录！");return false;}this.formPanel=new uft.extend.form.FormPanel({height:120,labelWidth:80,border:false,items:[{layout:"tableform",layoutConfig:{columns:2},border:false,padding:"5px 5px 0",defaults:{anchor:"95%",xtype:"textfield"},items:[{name:"receipt_man",fieldLabel:"回单人",allowBlank:false,itemCls:"uft-form-label-not-null",colspan:1},{xtype:"uftdatefield",name:"act_receipt_date",fieldLabel:"回单日期",allowBlank:false,itemCls:"uft-form-label-not-null",value:DateUtils.formatDate(new Date(),"yyyy-MM-dd"),colspan:1},{name:"receipt_exp_type",fieldLabel:"回单异常类型",xtype:"multiselectfield",colspan:1,dataUrl:ctxPath+"/datadict/getDataDict4MultiSelect.json",baseParams:{datatype_code:"exp_accident_type"}},{name:"receipt_memo",fieldLabel:"回单备注",colspan:2}]}]});uft.pod.ReceiptExp.superclass.constructor.call(this,{title:"异常回单",width:500,height:300,collapsible:false,frame:true,closable:true,draggable:true,resizable:true,modal:true,border:false,layout:"fit",items:[this.formPanel],buttons:[{iconCls:"btnYes",text:"保&nbsp;&nbsp;存",actiontype:"submit",scope:this,handler:this.saveAction},{iconCls:"btnCancel",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.destroy();}}]});};Ext.extend(uft.pod.ReceiptExp,Ext.Window,{saveAction:function(){var b=this.formPanel.getForm();var d=this.formPanel.getErrors();if(d.length!=0){uft.Utils.showWarnMsg(Utils.arrayToString(d,""));return;}var c=this.app.newAjaxParams();c.pk_invoice=this.record.data.pk_invoice;var a=b.getFieldValues(false);Ext.apply(c,a);uft.Utils.doAjax({scope:this,params:c,url:"expReceipt.json",success:function(e){if(e&&e.data){this.app.setAppValues(e.data,{updateToHeaderGrid:true,saveToCache:true,updateBody:false});if(typeof(this.app.getBillStatusField)=="function"){this.app.statusMgr.setBizStatus(e.data.HEADER[this.app.getBillStatusField()]);}this.app.statusMgr.updateStatus();}this.destroy();}});}});Ext.ns("uft.pod");uft.pod.PodAttach=function(c){Ext.apply(this,c);if(!this.record){uft.Utils.showErrorMsg("请先选择一条记录！");return false;}var a=Utils.doSyncRequest(ctxPath+"/pod/at/getTempletMap.json",{funCode:"t602",tabCode:"ts_pod_attach"},"POST");if(!a||!a.data){uft.Utils.showErrorMsg("没有模板数据，funCode：t602,tabcode:ts_pod_attach！");return false;}var d=a.data.records;var g=a.data.columns;var f=a.data.params;f.isBody="false";f.pk_invoice=this.record.data.pk_invoice;this.grid=new uft.extend.grid.BasicGrid({id:"ts_pod_attach",pkFieldName:"pk_pod_attach",dataUrl:ctxPath+"/pod/at/loadData.json",immediatelyLoad:true,singleSelect:false,isCheckboxSelectionModel:true,isAddBbar:false,params:f,recordType:d,columns:g});var b=ctxPath+"/pod/at/uploadPod.do?pk_invoice="+this.record.data.pk_invoice;var e=new Ext.Toolbar({defaults:{xtype:"button"},items:[{text:"上传",iconCls:"btnUpload",scope:this,handler:function(){var i=["doc","xdoc","xls","xlsx","pdf","jpg","jpeg","png"];var h=new uft.jf.FileUpload({uploadUrl:b,permitted_extensions:i}).show();h.on("fileupload",function(j){this.grid.getStore().reload();this.fireEvent("upload",this);},this);}},{text:"查看",iconCls:"btnDownload",scope:this,handler:function(){var h=uft.Utils.getSelectedRecords(this.grid);if(!h||h.length==0){uft.Utils.showWarnMsg("请选择记录！");return false;}if(h.length>1){uft.Utils.showWarnMsg("只能选择一条记录进行查看！");return false;}window.location.href=ctxPath+"/pod/at/download.do?pk_pod_attach="+h[0].data.pk_pod_attach;}},{text:"批量下载",scope:this,handler:function(){var h=uft.Utils.getSelectedRecords(this.grid);if(!h||h.length==0){uft.Utils.showWarnMsg("请选择记录！");return false;}var k="";for(var j=0;j<h.length;j++){k+=h[j].data.pk_pod_attach;if(j!=h.length-1){k+=",";}}window.location.href=ctxPath+"/pod/at/zipDownload.do?pk_pod_attach="+k;}},{text:"删除",iconCls:"btnDel",scope:this,handler:function(){var h=uft.Utils.getSelectedRecords(this.grid);if(!h||h.length==0){uft.Utils.showWarnMsg("请选择记录！");return false;}var k=[];for(var j=0;j<h.length;j++){k.push(h[j].data.pk_pod_attach);}Ext.Msg.confirm("确认","您确定要删除所选记录吗？",function(i){if(i=="yes"){var l={};l.billId=k;uft.Utils.doAjax({scope:this,method:"GET",url:ctxPath+"/pod/at/delete.json",actionType:"删除",params:l,success:function(m){for(var n=0;n<h.length;n++){this.grid.getStore().remove(h[n]);}}});}},this);}},{text:"刷新",iconCls:"btnRef",scope:this,handler:function(){this.grid.getStore().reload();}},{text:"预览",iconCls:"btnQuery",scope:this,handler:function(){var h=uft.Utils.getSelectedRecords(this.grid);if(!h||h.length==0){uft.Utils.showWarnMsg("请选择记录！");return false;}if(h.length>1){uft.Utils.showWarnMsg("只能选择一条记录进行查看！");return false;}window.open(ctxPath+"/pod/at/preview.do?pk_pod_attach="+h[0].data.pk_pod_attach);}}]});uft.pod.PodAttach.superclass.constructor.call(this,{title:"上传POD签收单",width:800,height:500,collapsible:false,frame:true,closable:true,draggable:true,resizable:true,modal:true,border:false,layout:"fit",tbar:e,items:[this.grid],buttons:[{iconCls:"btnCancel",text:"关&nbsp;&nbsp;闭",scope:this,handler:function(){this.destroy();}}]});};Ext.extend(uft.pod.PodAttach,Ext.Window,{});