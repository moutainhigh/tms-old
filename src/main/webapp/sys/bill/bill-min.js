Ext.namespace("uft.bill");uft.bill.ReftypeField=Ext.extend(Ext.form.TriggerField,{defaultAutoCreate:{tag:"input",type:"text",size:"24",autocomplete:"off"},triggerClass:"x-form-search-trigger",constructor:function(a){Ext.apply(this,a);uft.bill.ReftypeField.superclass.constructor.call(this);},onTriggerClick:function(){if(this.readOnly||this.disabled){return;}this.triggerBlur();var a=new uft.bill.ReftypeWindow({srcField:this});a.on("aftersubmit",function(c){if(this.gridEditor){var b=this.gridEditor.grid;b.startEditing(this.gridEditor.row,this.gridEditor.col);}this.setValueAfterSubmit(c);},this);a.show();},getValue:function(){return Ext.isDefined(this.value)?this.value:"";},clearValue:function(){this.setRawValue("");this.value="";},setValue:function(a){uft.bill.ReftypeField.superclass.setValue.call(this,a);this.value=a;return this;},setValueAfterSubmit:function(a){this.setValue(a);if(!this.isFocusAfterSubmit){if(this.gridEditor){this.gridEditor.grid.stopEditing();}}},setValueOnBlur:function(){this.setValue(this.el.dom.value);},triggerBlur:function(){this.mimicing=false;this.doc.un("mousedown",this.mimicBlur,this);if(this.monitorTab&&this.el){this.un("specialkey",this.checkTab,this);}this.beforeBlur();if(this.focusClass){this.el.removeClass(this.focusClass);}this.hasFocus=false;if(this.validationEvent!==false&&(this.validateOnBlur||this.validationEvent=="blur")){this.validate();}this.setValueOnBlur();this.fireEvent("blur",this);this.postBlur();if(this.wrap){this.wrap.removeClass(this.wrapFocusClass);}}});Ext.reg("reftypefield",uft.bill.ReftypeField);Ext.ns("uft.bill");uft.bill.ReftypeWindow=Ext.extend(Ext.Window,{shadow:false,width:600,height:300,srcField:null,constructor:function(a){Ext.apply(this,a);var e=this.srcField.getValue();var g=false,d=true,h=true,j="",k="";if(e){e=e.replace("&lt;","<");e=e.replace("&gt;",">");e=e.split(",");if(e[0].indexOf("<")==0){g=true;k=e[0];}else{j=e[0];}for(var c=0;c<e.length;c++){if(e[c]&&e[c].indexOf("code=")!=-1){var f=e[c].substring(e[c].indexOf("=")+1);d=f=="Y"?false:true;}else{if(e[c]&&e[c].indexOf("nl=")!=-1){var f=e[c].substring(e[c].indexOf("=")+1);h=f=="Y"?true:false;}}}}this.formPanel=new uft.extend.form.FormPanel({region:"north",labelWidth:135,layout:"fit",border:true,items:[{layout:"tableform",layoutConfig:{columns:2},border:true,padding:"5px 5px 0",defaults:{anchor:"98%",xtype:"textfield"},items:[{xtype:"uftcheckbox",id:"userdefine",name:"userdefine",fieldLabel:"是否自定义参照",checked:g,colspan:2},{xtype:"uftcombo",id:"systemref",name:"systemref",fieldLabel:"参照选择",dataUrl:"loadSystemRef.json",readOnly:g,value:j,colspan:1},{id:"userdefineref",name:"userdefineref",fieldLabel:"自定义参照类名称",realyOnly:g?false:true,itemCls:"uft-form-label-not-edit",value:k,colspan:1},{xtype:"uftcheckbox",id:"isleafcanselect",name:"isleafcanselect",fieldLabel:"是否可以选择非叶子节点",checked:h,colspan:1},{xtype:"uftcheckbox",id:"displaynamewhenblur",name:"displaynamewhenblur",fieldLabel:"焦点离开后参照显示名称",checked:d,colspan:1}]}]});var g=Ext.getCmp("userdefine");g.on("check",function(i,l){if(l=="Y"){Ext.getCmp("userdefineref").setReadOnly(false);Ext.getCmp("systemref").setReadOnly(true);}else{Ext.getCmp("userdefineref").setReadOnly(true);Ext.getCmp("systemref").setReadOnly(false);}},this);var b=[{xtype:"button",text:"确&nbsp;&nbsp;定",actiontype:"submit",scope:this,handler:function(){var n="";var i=Ext.getCmp("userdefine").getValue();if(i&&i=="Y"){n=Ext.getCmp("userdefineref").getValue();n=n.replace("<","&lt;");n=n.replace(">","&gt;");}else{n=Ext.getCmp("systemref").getValue();}if(n){var m=Ext.getCmp("displaynamewhenblur").getValue();if(m=="N"){n+=",";n+="code=Y";}var l=Ext.getCmp("isleafcanselect").getValue();if(l=="N"){n+=",";n+="nl=N";}}this.fireEvent("aftersubmit",n);this.close();}},{xtype:"button",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.close();}}];uft.bill.ReftypeWindow.superclass.constructor.call(this,{title:"参照选择定制对话框",width:this.width,height:this.height,collapsible:false,shim:true,frame:true,closable:true,draggable:false,modal:true,resizable:true,border:false,layout:"fit",items:[this.formPanel],buttonAlign:"center",buttons:b});}});Ext.namespace("uft.bill");uft.bill.DecimaltypeField=Ext.extend(Ext.form.TriggerField,{defaultAutoCreate:{tag:"input",type:"text",size:"24",autocomplete:"off"},triggerClass:"x-form-search-trigger",constructor:function(a){Ext.apply(this,a);uft.bill.DecimaltypeField.superclass.constructor.call(this);},onTriggerClick:function(){if(this.readOnly||this.disabled){return;}this.triggerBlur();var a=new uft.bill.DecimaltypeWindow({srcField:this});a.on("aftersubmit",function(c){if(this.gridEditor){var b=this.gridEditor.grid;b.startEditing(this.gridEditor.row,this.gridEditor.col);}this.setValueAfterSubmit(c);},this);a.show();},getValue:function(){return Ext.isDefined(this.value)?this.value:"";},clearValue:function(){this.setRawValue("");this.value="";},setValue:function(a){uft.bill.DecimaltypeField.superclass.setValue.call(this,a);this.value=a;return this;},setValueAfterSubmit:function(a){this.setValue(a);if(!this.isFocusAfterSubmit){if(this.gridEditor){this.gridEditor.grid.stopEditing();}}},setValueOnBlur:function(){this.setValue(this.el.dom.value);},triggerBlur:function(){this.mimicing=false;this.doc.un("mousedown",this.mimicBlur,this);if(this.monitorTab&&this.el){this.un("specialkey",this.checkTab,this);}this.beforeBlur();if(this.focusClass){this.el.removeClass(this.focusClass);}this.hasFocus=false;if(this.validationEvent!==false&&(this.validateOnBlur||this.validationEvent=="blur")){this.validate();}this.setValueOnBlur();this.fireEvent("blur",this);this.postBlur();if(this.wrap){this.wrap.removeClass(this.wrapFocusClass);}}});Ext.reg("decimaltypefield",uft.bill.DecimaltypeField);Ext.ns("uft.bill");uft.bill.DecimaltypeWindow=Ext.extend(Ext.Window,{shadow:false,width:400,height:200,srcField:null,constructor:function(b){Ext.apply(this,b);var e=this.srcField.getValue();var g=2,f=false,c=false;if(e){var a=e.split(",");g=a[0];if(a.length>5){f=a[5]=="Y";}if(a.length>6){c=a[6]=="Y";}}this.formPanel=new uft.extend.form.FormPanel({labelWidth:100,layout:"form",border:true,frame:true,defaults:{autoHeight:true,bodyStyle:"padding:10px"},items:[{xtype:"uftnumberfield",decimalPrecision:0,id:"number_precision",style:"text-align: right",fieldLabel:"自定义精度",value:g},{xtype:"uftcheckbox",id:"thousands_format",fieldLabel:"显示千分位",checked:f},{xtype:"uftcheckbox",id:"zeroToNull",fieldLabel:"零显示为空",checked:c}]});var d=[{xtype:"button",text:"确&nbsp;&nbsp;定",actiontype:"submit",scope:this,handler:function(){var k=Ext.getCmp("number_precision").getValue();var j=Ext.getCmp("thousands_format").getValue();var h=Ext.getCmp("zeroToNull").getValue();var i=k;if(j=="Y"){i+=",,,,,Y,";}if(h=="Y"){if(j=="Y"){i+="Y";}else{i+=",,,,,,Y";}}this.fireEvent("aftersubmit",i);this.close();}},{xtype:"button",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.close();}}];uft.bill.DecimaltypeWindow.superclass.constructor.call(this,{title:"类型设置",width:this.width,height:this.height,collapsible:false,shim:true,frame:true,closable:true,draggable:false,modal:true,resizable:true,border:false,layout:"fit",items:[this.formPanel],buttonAlign:"center",buttons:d});}});Ext.namespace("uft.bill");uft.bill.SelecttypeField=Ext.extend(Ext.form.TriggerField,{defaultAutoCreate:{tag:"input",type:"text",size:"24",autocomplete:"off"},triggerClass:"x-form-search-trigger",constructor:function(a){Ext.apply(this,a);uft.bill.SelecttypeField.superclass.constructor.call(this);},onTriggerClick:function(){if(this.readOnly||this.disabled){return;}this.triggerBlur();var a=new uft.bill.SelecttypeWindow({startValue:this.gridEditor.startValue});a.on("aftersubmit",function(c){if(this.gridEditor){var b=this.gridEditor.grid;b.startEditing(this.gridEditor.row,this.gridEditor.col);}this.setValueAfterSubmit(c);},this);a.show();},getValue:function(){return Ext.isDefined(this.value)?this.value:"";},clearValue:function(){this.setRawValue("");this.value="";},setValue:function(a){uft.bill.SelecttypeField.superclass.setValue.call(this,a);this.value=a;return this;},setValueOnBlur:function(){this.setValue(this.el.dom.value);},triggerBlur:function(){this.mimicing=false;this.doc.un("mousedown",this.mimicBlur,this);if(this.monitorTab&&this.el){this.un("specialkey",this.checkTab,this);}this.beforeBlur();if(this.focusClass){this.el.removeClass(this.focusClass);}this.hasFocus=false;if(this.validationEvent!==false&&(this.validateOnBlur||this.validationEvent=="blur")){this.validate();}this.setValueOnBlur();this.fireEvent("blur",this);this.postBlur();if(this.wrap){this.wrap.removeClass(this.wrapFocusClass);}},setValueAfterSubmit:function(a){this.setValue(a);if(!this.isFocusAfterSubmit){if(this.gridEditor){this.gridEditor.grid.stopEditing();}}},setValueOnBlur:function(){this.setValue(this.el.dom.value);},triggerBlur:function(){this.mimicing=false;this.doc.un("mousedown",this.mimicBlur,this);if(this.monitorTab&&this.el){this.un("specialkey",this.checkTab,this);}this.beforeBlur();if(this.focusClass){this.el.removeClass(this.focusClass);}this.hasFocus=false;if(this.validationEvent!==false&&(this.validateOnBlur||this.validationEvent=="blur")){this.validate();}this.setValueOnBlur();this.fireEvent("blur",this);this.postBlur();if(this.wrap){this.wrap.removeClass(this.wrapFocusClass);}}});Ext.reg("selecttypefield",uft.bill.SelecttypeField);Ext.ns("uft.bill");uft.bill.SelecttypeWindow=Ext.extend(Ext.Window,{constructor:function(a){Ext.apply(this,a);this.s_selectfield=new Ext.ux.form.MultiSelect({hideLabel:true,newlineflag:true,height:175,name:"s_selectfield",displayField:"text",valueField:"value",store:new Ext.data.JsonStore({root:"records",fields:["value","text"]})});this.s_selectfield.on("_add",this.updateStatus,this);this.s_selectfield.on("_update",this.updateStatus,this);this.s_selectfield.on("_remove",this.updateStatus,this);this.s_selectfield.on("_clear",this.updateStatus,this);this.formPanel=new uft.extend.form.FormPanel({labelWidth:90,border:true,items:[{layout:"form",border:false,padding:"5px 5px 0",defaults:{anchor:"98%"},items:[{fieldLabel:"返回值设置",xtype:"radiogroup",id:"returnValueTypeRadio",items:[{boxLabel:"返回值",name:"returnValueType",inputValue:"S",checked:true},{boxLabel:"返回索引",name:"returnValueType",inputValue:"I"},{hidden:true}]},{fieldLabel:"值类型设置",xtype:"radiogroup",id:"valueTypeRadio",items:[{boxLabel:"普通",name:"valueType",inputValue:""},{boxLabel:"名值对方式",name:"valueType",inputValue:"X",checked:true},{boxLabel:"数据库方式",name:"valueType",inputValue:"F",id:"databaseValueType"}]},{autoWidth:true,xtype:"fieldset",title:"枚举值设置",layout:"tableform",height:230,labelWidth:60,layoutConfig:{columns:3},items:[{xtype:"textfield",fieldLabel:"表名",colspan:1,id:"s_tablename",name:"s_tablename"},{xtype:"textfield",fieldLabel:"字段名",colspan:1,id:"s_fieldname",name:"s_fieldname"},{colspan:2,border:false,layout:"fit",height:180,autoScroll:false,items:[this.s_selectfield]},{colspan:1,border:false,padding:"8px 0 0 5px",baseCls:"x-plain",xtype:"buttongroup",id:"s_buttongroup",width:50,layoutConfig:{columns:1},items:[{text:"增加",width:50,cls:"x-btn-padd",scope:this,handler:function(){var d=this.formPanel.getForm();var c=d.getFieldValues(false);var f=Ext.getCmp("valueTypeRadio").getValue();var e=new uft.bill.InputValueWin({s_selectfield:this.s_selectfield,valueType:f,isAdd:true});e.show();}},{text:"修改",width:50,cls:"x-btn-padd",scope:this,handler:function(){var e=this.s_selectfield.view.getSelectedIndexes();if(e&&e.length>1){uft.Utils.showWarnMsg("有且只能选择一行记录！");return;}var d=this.formPanel.getForm();var c=d.getFieldValues(false);var g=Ext.getCmp("valueTypeRadio").getValue();var f=new uft.bill.InputValueWin({s_selectfield:this.s_selectfield,valueType:g,isAdd:false});f.show();}},{text:"删除",width:50,cls:"x-btn-padd",scope:this,handler:function(){var e=this.s_selectfield.view.getSelectedIndexes();if(e&&e.length>1){uft.Utils.showWarnMsg("有且只能选择一行记录！");return;}var d=this.s_selectfield.view.store;var c=d.getAt(e[0]);d.remove(c);}},{text:"清除",width:50,cls:"x-btn-padd",scope:this,handler:function(){this.s_selectfield.clearRecord();}}]}]}]}]});var b=[{xtype:"button",text:"确&nbsp;&nbsp;定",actiontype:"submit",scope:this,handler:function(){var e=this.formPanel.getForm();if(e.isValid()){var d="";var n=e.getFieldValues(false);var g=Ext.getCmp("returnValueTypeRadio").getValue();var f=Ext.getCmp("valueTypeRadio").getValue();d+=g;d+=f;if(f=="F"){var h=n.s_tablename||"";var k=n.s_fieldname||"";d+=",";d+=h;d+=",";d+=k;}else{var m=this.s_selectfield.view.store,l=m.getCount();for(var j=0;j<l;j++){var c=m.getAt(j);d+=",";d+=c.get(this.s_selectfield.valueField);}}}this.fireEvent("aftersubmit",d);this.close();}},{xtype:"button",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.close();}}];uft.bill.SelecttypeWindow.superclass.constructor.call(this,{title:"下拉类型设置",width:550,height:370,collapsible:false,shim:true,frame:true,closable:true,draggable:false,modal:true,resizable:true,border:false,layout:"fit",items:[this.formPanel],buttons:b});},restoreValue:function(){if(!this.startValue){return;}var d=Ext.getCmp("returnValueTypeRadio");var h=Ext.getCmp("valueTypeRadio");var c=Ext.getCmp("s_tablename");var a=Ext.getCmp("s_fieldname");var f=this.startValue.split(",");if(f[0].indexOf("S")==0||f[0].indexOf("CG")==0||f[0].indexOf("RG")==0){d.items.items[0].setValue("S");}else{d.items.items[1].setValue("I");}if(f[0].indexOf("SX")==0||f[0].indexOf("IX")==0||f[0].indexOf("CG")==0||f[0].indexOf("RG")==0){h.items.items[1].setValue("X");var b=[];for(var e=1;e<f.length;e++){var g={};g[this.s_selectfield.displayField]=f[e];g[this.s_selectfield.valueField]=f[e];b.push(g);}this.s_selectfield.setRecord(b);}else{if(f[0].indexOf("SF")==0||f[0].indexOf("IF")==0){h.items.items[2].setValue("F");c.setValue(f[1]);a.setValue(f[2]);}else{h.items.items[0].setValue("");var b=[];for(var e=1;e<f.length;e++){var g={};g[this.s_selectfield.displayField]=f[e];g[this.s_selectfield.valueField]=f[e];b.push(g);}this.s_selectfield.setRecord(b);}}},updateStatus:function(){var e=Ext.getCmp("valueTypeRadio");var c=Ext.getCmp("s_tablename");var a=Ext.getCmp("s_fieldname");c.setReadOnly(true);a.setReadOnly(true);var b=this.s_selectfield.view.store;if(b.getCount()>0){e.items.each(function(f){f.disable();});}else{e.items.each(function(f){f.enable();});}var d=e.getValue();if(d.inputValue=="F"){this.setStatusIfDBType(true);}else{this.setStatusIfDBType(false);}},setStatusIfDBType:function(d){var b=Ext.getCmp("s_tablename");var a=Ext.getCmp("s_fieldname");var c=Ext.getCmp("s_buttongroup");if(d){b.setReadOnly(false);a.setReadOnly(false);c.items.each(function(e){e.disable();});}else{b.setValue(null);a.setValue(null);b.setReadOnly(true);a.setReadOnly(true);c.items.each(function(e){e.enable();});}},afterRender:function(){uft.bill.SelecttypeWindow.superclass.afterRender.call(this);this.updateStatus();this.restoreValue();var a=Ext.getCmp("valueTypeRadio");a.items.each(function(b){b.on("aftercheck",function(c,d){if(c.id=="databaseValueType"){this.setStatusIfDBType(true);}else{this.setStatusIfDBType(false);}},this);},this);}});uft.bill.InputValueWin=Ext.extend(Ext.Window,{constructor:function(b){Ext.apply(this,b);var a=this.s_selectfield;var c=this.valueType;var m=this.isAdd;var e="",k="";if(!m){var l=a.view.store;var j=a.view.getSelectedIndexes();var g=l.getAt(j[0]);var h=g.get(a.valueField);if(h.indexOf("=")!=-1){var f=h.split("=");e=f[0];k=f[1];}else{k=h;}}var i=[];if(c=="X"){i.push({fieldLabel:"显示名称",name:"s_displayname",value:e,itemCls:"uft-form-label-not-null",allowBlank:false});}i.push({fieldLabel:"值",name:"s_value",value:k,itemCls:"uft-form-label-not-null",allowBlank:false});this.form=new uft.extend.form.FormPanel({labelWidth:80,border:false,autoWidth:true,autoHeight:true,frame:true,defaults:{xtype:"textfield",allowBlank:false,anchor:"85%",width:200},items:i});var d=[];d.push({xtype:"button",text:"确&nbsp;&nbsp;定",actiontype:"submit",scope:this,handler:function(){var p=this.form.getForm();if(p.isValid()){var o;var n=p.getFieldValues(false);if(c=="X"){o=n.s_displayname;o+="=";o+=n.s_value;}else{o=n.s_value;}var q={};q[a.valueField]=o;q[a.displayField]=o;if(m){a.addRecord([q]);}else{a.updateRecord(q);}this.close();}}},{xtype:"button",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.close();}});uft.bill.InputValueWin.superclass.constructor.call(this,{title:"输入值",width:300,autoHeight:true,layout:"fit",shim:true,frame:true,closable:true,draggable:true,border:false,modal:true,items:[this.form],buttons:d});}});Ext.ns("uft.bill");uft.bill.NewTabWin=Ext.extend(Ext.Window,{constructor:function(b){Ext.apply(this,b);var d=this.et;var a=[];a.push({fieldLabel:"页签编码",name:"tabcode",itemCls:"uft-form-label-not-null",allowBlank:false,value:this.tabcode});a.push({fieldLabel:"页签名称",name:"tabname",itemCls:"uft-form-label-not-null",allowBlank:false});this.form=new uft.extend.form.FormPanel({labelWidth:80,border:false,autoWidth:true,autoHeight:true,frame:true,defaults:{xtype:"textfield",allowBlank:false,anchor:"85%",width:200},monitorValid:true,items:a});var c=[];c.push({xtype:"button",text:"确&nbsp;&nbsp;定",actiontype:"submit",scope:this,handler:this.saveHandler},{xtype:"button",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.close();}});uft.bill.NewTabWin.superclass.constructor.call(this,{title:"录入页签编码和名称",width:300,layout:"fit",shim:true,frame:true,closable:true,draggable:true,border:false,modal:true,items:[this.form],buttons:c});},saveHandler:function(){if(this.form.getForm().isValid()){var b=this.form.getForm().getFieldValues(false);var a=b.tabcode;if(this.et.hasTab(a)){uft.Utils.showWarnMsg("页签名称已存在，请换一个！");return false;}this.fireEvent("ok",this,b);this.close();}}});uft.bill.TabWin=Ext.extend(Ext.Window,{constructor:function(c){Ext.apply(this,c);var j=this.et;var a=this.grid;var h=[];var g=this.et.getTabs(a);for(var f=0;f<g.length;f++){if(g[f].tabcode!=a.tabcode){var e=[];e.push(g[f].title);e.push(g[f].tabcode);h.push(e);}}var k=new Ext.data.SimpleStore({fields:["text","value"],data:h});var b=new uft.extend.form.LocalCombox({name:"tabcode",fieldLabel:"选择页签",allowBlank:false,value:h[0][1],store:k});this.form=new uft.extend.form.FormPanel({labelWidth:80,border:false,autoWidth:true,autoHeight:true,frame:true,defaults:{xtype:"textfield",allowBlank:false,anchor:"85%",width:200},monitorValid:true,items:[b]});var d=[];d.push({xtype:"button",text:"确&nbsp;&nbsp;定",actiontype:"submit",scope:this,handler:this.saveHandler},{xtype:"button",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.close();}});uft.bill.TabWin.superclass.constructor.call(this,{title:"录入页签编码和名称",width:300,layout:"fit",shim:true,frame:true,closable:true,draggable:true,border:false,modal:true,items:[this.form],buttons:d});},saveHandler:function(){if(this.form.getForm().isValid()){var a=this.form.getForm().getFieldValues(false);this.fireEvent("ok",this,a.tabcode);this.close();}}});uft.bill.OrderWin=Ext.extend(Ext.Window,{rightButtonWidth:50,constructor:function(d){Ext.apply(this,d);var k=this.et;var a=this.grid;var m=a.getStore(),h=m.getCount();var c=[];for(var f=0;f<h;f++){var g=m.getAt(f);var b=g.get("itemkey");var l=g.get("defaultshowname");if(b&&b.length>0&&l&&l.length>0){c.push({id:b,text:l,leaf:true});}}var j={text:"root",expended:true,children:c};this.tree=new Ext.tree.TreePanel({width:275,height:200,rootVisible:false,autoScroll:true,enableDD:true,root:j});this.form=new uft.extend.form.FormPanel({border:false,autoWidth:true,autoHeight:true,frame:false,layout:"table",layoutConfig:{columns:2},items:[{border:false,layout:"fit",items:[this.tree]},{border:false,padding:"8px 0 0 5px",baseCls:"x-plain",xtype:"buttongroup",width:50,layoutConfig:{columns:1},items:[{xtype:"button",width:this.rightButtonWidth,iconCls:"top",cls:"x-btn-padd",scope:this,handler:function(){var n=this.tree.getSelectionModel().getSelectedNode();if(!n){return;}var i=n.parentNode;var o=i.firstChild;i.insertBefore(n,o);this.tree.getSelectionModel().select(n);}},{xtype:"button",width:this.rightButtonWidth,iconCls:"up",cls:"x-btn-padd",scope:this,handler:function(){var o=this.tree.getSelectionModel().getSelectedNode();if(!o){return;}var i=o.parentNode;var n=o.previousSibling;i.insertBefore(o,n);this.tree.getSelectionModel().select(o);}},{xtype:"button",width:this.rightButtonWidth,iconCls:"down",cls:"x-btn-padd",scope:this,handler:function(){var o=this.tree.getSelectionModel().getSelectedNode();if(!o){return;}var n=o.parentNode;var i=o.nextSibling;if(!i){i=n.firstChild;}else{i=i.nextSibling;}n.insertBefore(o,i);this.tree.getSelectionModel().select(o);}},{xtype:"button",width:this.rightButtonWidth,iconCls:"bottom",cls:"x-btn-padd",scope:this,handler:function(){var n=this.tree.getSelectionModel().getSelectedNode();if(!n){return;}var i=n.parentNode;i.appendChild(n);this.tree.getSelectionModel().select(n);}}]}]});var e=[];e.push({xtype:"button",text:"确&nbsp;&nbsp;定",actiontype:"submit",scope:this,handler:this.saveHandler},{xtype:"button",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.close();}});uft.bill.OrderWin.superclass.constructor.call(this,{title:"项目移动重排",width:350,height:250,autoHeight:true,layout:"fit",shim:true,frame:true,closable:true,draggable:true,border:false,modal:true,items:[this.form],buttons:e});},saveHandler:function(){var a=this.tree.getRootNode();var c=a.childNodes;var d=[];for(var b=0;b<c.length;b++){d.push(c[b].id);}this.fireEvent("ok",this,d);this.close();}});uft.bill.SaveBillWin=Ext.extend(Ext.Window,{constructor:function(c){Ext.apply(this,c);var f=this.et;var a=f.templetDesc.bill_templetcaption;var d=f.templetDesc.nodecode;var b=[];b.push({fieldLabel:"模板标题",name:"bill_templetcaption",value:a,itemCls:"uft-form-label-not-null",allowBlank:false});b.push({refName:"功能节点档案",xtype:"headerreffield",name:"nodecode",fieldLabel:"节点号",itemCls:"uft-form-label-not-null",allowBlank:false,fillinable:true,value:d,refWindow:{model:0,leafflag:true,treeDataUrl:ctxPath+"/ref/common/funwithbtn/load4Tree.json"},pkField:"fun_code",codeField:"fun_code",nameField:"fun_code",showCodeOnBlur:true,getByPkUrl:ctxPath+"/ref/common/funwithbtn/getByPk.do",getByCodeUrl:ctxPath+"/ref/common/funwithbtn/getByCode.do"});this.form=new uft.extend.form.FormPanel({labelWidth:80,border:false,autoWidth:true,autoHeight:true,frame:true,defaults:{xtype:"textfield",allowBlank:false,anchor:"85%",width:200},monitorValid:true,items:b});var e=[];e.push({xtype:"button",text:"保&nbsp;&nbsp;存",actiontype:"submit",scope:this,handler:this.saveHandler},{xtype:"button",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.destroy();}});uft.bill.SaveBillWin.superclass.constructor.call(this,{title:"保存模板",width:300,autoHeight:true,layout:"fit",shim:true,frame:true,closable:true,draggable:true,border:false,modal:true,items:[this.form],buttons:e});},saveHandler:function(){if(this.form.getForm().isValid()){var a=this.form.getForm().getFieldValues(false);this.fireEvent("ok",this,a);this.destroy();}}});uft.bill.CopyBillWin=Ext.extend(Ext.Window,{constructor:function(c){Ext.apply(this,c);var a=this.bill_templetcaption;var d=this.nodecode;var b=[];b.push({fieldLabel:"模板名称",name:"bill_templetcaption",value:a,itemCls:"uft-form-label-not-null",allowBlank:false});b.push({refName:"功能节点档案",xtype:"headerreffield",name:"nodecode",fieldLabel:"节点号",value:d,itemCls:"uft-form-label-not-null",allowBlank:false,fillinable:true,refWindow:{model:0,leafflag:true,treeDataUrl:ctxPath+"/ref/common/fun/load4Tree.json"},pkField:"fun_code",codeField:"fun_code",nameField:"fun_code",showCodeOnBlur:true,getByPkUrl:ctxPath+"/ref/common/fun/getByPk.do",getByCodeUrl:ctxPath+"/ref/common/fun/getByCode.do"});this.form=new uft.extend.form.FormPanel({labelWidth:80,border:false,autoWidth:true,autoHeight:true,frame:true,defaults:{xtype:"textfield",allowBlank:false,anchor:"85%",width:200},monitorValid:true,items:b});var e=[];e.push({xtype:"button",text:"保&nbsp;&nbsp;存",actiontype:"submit",scope:this,handler:this.saveHandler},{xtype:"button",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.close();}});uft.bill.CopyBillWin.superclass.constructor.call(this,{title:"复制模板",width:300,autoHeight:true,layout:"fit",shim:true,frame:true,closable:true,draggable:true,border:false,modal:true,items:[this.form],buttons:e});},saveHandler:function(){if(this.form.getForm().isValid()){var a=this.form.getForm().getFieldValues(false);if(a.bill_templetcaption==this.bill_templetcaption){uft.Utils.showInfoMsg("请使用其他模板名称！");return;}this.fireEvent("ok",this,a);this.close();}}});uft.bill.AdjustWin=Ext.extend(Ext.Window,{rightButtonWidth:60,constructor:function(f){Ext.apply(this,f);var m=this.et;var b=this.grid;var o=b.getStore(),k=o.getCount();var e=[];for(var h=0;h<k;h++){var j=o.getAt(h);var c=j.get("itemkey");var n=j.get("defaultshowname");if(c&&c.length>0&&n&&n.length>0){e.push({id:c,text:n,leaf:true});}}var l={text:"列字段",expended:true,children:e};this.tree=new Ext.tree.TreePanel({width:400,height:285,rootVisible:false,autoScroll:true,enableDD:true,selModel:new Ext.tree.MultiSelectionModel(),root:l});this.tree.on("click",function(i,p){if(i.parentNode.isRoot){a.enable();if(i.childNodes&&i.childNodes.length>0){d.enable();}else{d.disable();}}else{a.disable();d.disable();}},this);var a=new Ext.Button({width:this.rightButtonWidth,text:"合并",cls:"x-btn-padd",disabled:true,scope:this,handler:function(){var i=this.tree.getSelectionModel().getSelectedNodes();if(!i||i.length==0||i.length==1){uft.Utils.showWarnMsg("请至少选择两个节点！");return;}var p=new uft.bill.NewNodeWin({tree:this.tree});p.on("ok",function(v,u){var q=new Ext.tree.TreeNode({id:u,text:u});var t=i[i.length-1];var s=t.nextSibling;if(s){s.parentNode.insertBefore(q,s);}else{t.parentNode.appendChild(q);}for(var r=0;r<i.length;r++){q.appendChild(i[r]);}q.expand();},this);p.show();}});var d=new Ext.Button({width:this.rightButtonWidth,text:"拆分",cls:"x-btn-padd",disabled:true,scope:this,handler:function(){var A=this.tree.getSelectionModel().getSelectedNodes();if(!A||A.length==0){return;}var s=this.grid.getStore(),y=s.getCount();for(var v=0;v<A.length;v++){var x=A[v].parentNode;var w=A[v].nextSibling;var B=A[v].childNodes;if(B){var z=B.length;for(var u=0;u<z;u++){var q=B[0].id;if(w){x.insertBefore(B[0],w);}else{x.appendChild(B[0]);}for(var t=0;t<y;t++){var p=s.getAt(t);if(p.get("itemkey")==q){p.set("options",null);break;}}}}x.removeChild(A[v]);}}});this.form=new uft.extend.form.FormPanel({border:false,frame:false,layout:"table",layoutConfig:{columns:2},items:[{border:false,layout:"fit",items:[this.tree]},{border:false,padding:"8px 0 0 5px",baseCls:"x-plain",xtype:"buttongroup",width:75,layoutConfig:{columns:1},items:[{xtype:"button",width:this.rightButtonWidth,iconCls:"top",cls:"x-btn-padd",scope:this,handler:function(){var p=this.tree.getSelectionModel().getSelectedNodes();if(!p||p.length==0){return;}for(var q=0;q<p.length;q++){var s=p[q];var r=s.parentNode;var t=r.firstChild;r.insertBefore(s,t);this.tree.getSelectionModel().select(s);}}},{xtype:"button",width:this.rightButtonWidth,iconCls:"up",cls:"x-btn-padd",scope:this,handler:function(){var p=this.tree.getSelectionModel().getSelectedNodes();if(!p||p.length==0){return;}for(var q=0;q<p.length;q++){var t=p[q];var r=t.parentNode;var s=t.previousSibling;r.insertBefore(t,s);this.tree.getSelectionModel().select(t);}}},{xtype:"button",width:this.rightButtonWidth,iconCls:"down",cls:"x-btn-padd",scope:this,handler:function(){var p=this.tree.getSelectionModel().getSelectedNodes();if(!p||p.length==0){return;}for(var q=0;q<p.length;q++){var t=p[q];var s=t.parentNode;var r=t.nextSibling;if(!r){r=s.firstChild;}else{r=r.nextSibling;}s.insertBefore(t,r);this.tree.getSelectionModel().select(t);}}},{xtype:"button",width:this.rightButtonWidth,iconCls:"bottom",cls:"x-btn-padd",scope:this,handler:function(){var p=this.tree.getSelectionModel().getSelectedNodes();if(!p||p.length==0){return;}for(var q=0;q<p.length;q++){var s=p[q];var r=s.parentNode;r.appendChild(s);this.tree.getSelectionModel().select(s);}}},a,d]}]});var g=[];g.push({xtype:"button",text:"确&nbsp;&nbsp;定",actiontype:"submit",scope:this,handler:this.saveHandler},{xtype:"button",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.close();}});uft.bill.AdjustWin.superclass.constructor.call(this,{title:"设置树结构",width:500,height:350,layout:"fit",shim:true,frame:true,closable:true,draggable:true,border:false,modal:true,items:[this.form],buttons:g});},afterRender:function(){uft.bill.AdjustWin.superclass.afterRender.call(this);this.resovleOptions();},saveHandler:function(){var a=this.tree.getRootNode();a.cascade(function(f){var j=this.getMulicolhead(f);if(j&&j.length>0){var d=f.id;var e=this.grid.getStore(),l=e.getCount();var k,g=this.grid.tabcode,c,m;for(var h=0;h<l;h++){var b=e.getAt(h);if(b.get("itemkey")==d){k=b;break;}}c=b.get("showflag")=="1"?"Y":"N";m=b.get("listshowflag");var n=this.buildOptions(g,c,m,j);k.set("options",n);}},this);this.fireEvent("ok",this);this.close();},getMulicolhead:function(a){if(!a.leaf){return"";}var c="";a=a.parentNode;while(a&&!a.isRoot){var b=a.id;if(c.length>0){c=b+"_"+c;}else{c=b;}a=a.parentNode;}return c;},buildOptions:function(b,e,c,a){var d='<root><tab code="{tabcode}" showflag="{showflag}" listshowflag="{listshowflag}" mulicolhead="{mulicolhead}" /></root>';d=d.replace("{tabcode}",b).replace("{showflag}",e).replace("{listshowflag}",c).replace("{mulicolhead}",a);d=d.replace(/</g,"&lt;");d=d.replace(/>/g,"&gt;");return d;},resovleOptions:function(){var c=this.grid.getStore(),l=c.getCount();for(var g=0;g<l;g++){var a=c.getAt(g);var o=a.get("options");var b=a.get("itemkey");if(o&&o.length>0){var m=o.indexOf('mulicolhead="');if(m>0){o=o.substring(m+13);m=o.indexOf('"');var k=this.tree.getRootNode();var d=this.tree.getNodeById(b);var h=d.nextSibling;var f=o.substring(0,m);f=f.split("_");for(var e=0;e<f.length;e++){var n=this.tree.getNodeById(f[e]);if(!n){n=new Ext.tree.TreeNode({id:f[e],text:f[e],expanded:true});if(e==0){k=this.tree.getRootNode();if(h){k.insertBefore(n,h);}else{k.appendChild(n);}}else{k.appendChild(n);}}k=n;}k.appendChild(d);}}}this.tree.doLayout();}});uft.bill.NewNodeWin=Ext.extend(Ext.Window,{constructor:function(b){Ext.apply(this,b);var a=[];a.push({fieldLabel:"合并后名称",name:"parentName",itemCls:"uft-form-label-not-null",allowBlank:false});this.form=new uft.extend.form.FormPanel({labelWidth:80,border:false,autoWidth:true,autoHeight:true,frame:true,defaults:{xtype:"textfield",allowBlank:false,anchor:"85%",width:200},monitorValid:true,items:a});var c=[];c.push({xtype:"button",text:"确&nbsp;&nbsp;定",actiontype:"submit",scope:this,handler:this.saveHandler},{xtype:"button",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.close();}});uft.bill.NewNodeWin.superclass.constructor.call(this,{title:"请输入合并后的名称",width:300,layout:"fit",shim:true,frame:true,closable:true,draggable:true,border:false,modal:true,items:[this.form],buttons:c});},saveHandler:function(){if(this.form.getForm().isValid()){var b=this.form.getForm().getFieldValues(false);var c=b.parentName;var a=this.tree.getRootNode();a.cascade(function(d){var e=d.attributes.code;if(e){if(e==c){uft.Utils.showWarnMsg("节点名称已经存在，请换一个！");return;}}});this.fireEvent("ok",this,c);this.close();}}});uft.bill.BuildQueryTempletWin=Ext.extend(Ext.Window,{constructor:function(b){Ext.apply(this,b);var a=[];a.push({fieldLabel:"模板标题",name:"model_name",itemCls:"uft-form-label-not-null",allowBlank:false});a.push({refName:"功能节点档案",xtype:"headerreffield",name:"node_code",fieldLabel:"节点号",itemCls:"uft-form-label-not-null",allowBlank:false,fillinable:true,refWindow:{model:0,leafflag:true,treeDataUrl:ctxPath+"/ref/common/fun/load4Tree.json"},pkField:"fun_code",codeField:"fun_code",nameField:"fun_code",showCodeOnBlur:true,getByPkUrl:ctxPath+"/ref/common/fun/getByPk.do",getByCodeUrl:ctxPath+"/ref/common/fun/getByCode.do"});a.push({fieldLabel:"是否覆盖",inputValue:"true",name:"cover",xtype:"uftcheckbox"});this.form=new uft.extend.form.FormPanel({labelWidth:80,border:false,autoWidth:true,autoHeight:true,frame:true,defaults:{xtype:"textfield",allowBlank:false,anchor:"85%",width:200},items:a});var c=[];c.push({xtype:"button",text:"确&nbsp;&nbsp;定",actiontype:"submit",scope:this,handler:this.saveHandler},{xtype:"button",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.close();}});uft.bill.BuildQueryTempletWin.superclass.constructor.call(this,{title:"生成查询模板对话框",width:300,layout:"fit",shim:true,frame:true,closable:true,draggable:true,border:false,modal:true,items:[this.form],buttons:c});},saveHandler:function(){if(this.form.getForm().isValid()){var a=this.form.getForm().getFieldValues(false);this.fireEvent("ok",this,a);this.close();}}});uft.bill.BuildReportTempletWin=Ext.extend(Ext.Window,{constructor:function(b){Ext.apply(this,b);var a=[];a.push({fieldLabel:"模板标题",name:"vtemplatename",itemCls:"uft-form-label-not-null",allowBlank:false});a.push({refName:"功能节点档案",xtype:"headerreffield",name:"nodecode",fieldLabel:"节点号",itemCls:"uft-form-label-not-null",allowBlank:false,fillinable:true,refWindow:{model:0,leafflag:true,treeDataUrl:ctxPath+"/ref/common/fun/load4Tree.json"},pkField:"fun_code",codeField:"fun_code",nameField:"fun_code",showCodeOnBlur:true,getByPkUrl:ctxPath+"/ref/common/fun/getByPk.do",getByCodeUrl:ctxPath+"/ref/common/fun/getByCode.do"});a.push({fieldLabel:"是否覆盖",inputValue:"true",name:"cover",xtype:"uftcheckbox"});this.form=new uft.extend.form.FormPanel({labelWidth:80,border:false,autoWidth:true,autoHeight:true,frame:true,defaults:{xtype:"textfield",allowBlank:false,anchor:"85%",width:200},items:a});var c=[];c.push({xtype:"button",text:"确&nbsp;&nbsp;定",actiontype:"submit",scope:this,handler:this.saveHandler},{xtype:"button",text:"取&nbsp;&nbsp;消",scope:this,handler:function(){this.close();}});uft.bill.BuildReportTempletWin.superclass.constructor.call(this,{title:"生成报表模板对话框",width:300,layout:"fit",shim:true,frame:true,closable:true,draggable:true,border:false,modal:true,items:[this.form],buttons:c});},saveHandler:function(){if(this.form.getForm().isValid()){var a=this.form.getForm().getFieldValues(false);this.fireEvent("ok",this,a);this.close();}}});Ext.ns("uft.bill");uft.bill.GridContextMenu=Ext.extend(Ext.menu.Menu,{constructor:function(a){Ext.apply(this,a);if(!this.grid){uft.Utils.showWarnMsg("表格参数是必须的！");return false;}var c=this.et;var b=this.grid;uft.bill.GridContextMenu.superclass.constructor.call(this,{items:[{text:"增加自定义项目...",scope:this,handler:function(){c.addNullField(b);}},{text:"增加自定义项目到新页签...",scope:this,handler:function(){var d=new uft.bill.NewTabWin({et:c});d.show();d.on("ok",function(f,e){c.addNullFieldToNewTab(b,e);},this);}},"-",{text:"项目重新排序...",scope:this,handler:function(){var d=new uft.bill.OrderWin({et:c,grid:b});d.on("ok",function(f,e){c.reOrderField(b,e);},this);d.show();}},{text:"项目结构调整...",scope:this,handler:function(){var d=new uft.bill.AdjustWin({et:c,grid:b});d.show();}},{text:"删除页签...",scope:this,handler:function(){Ext.Msg.confirm("确认","确定删除吗？",function(d){if(d=="yes"){c.deleteTab(b);}},this);}}]});}});uft.bill.RowContextMenu=Ext.extend(Ext.menu.Menu,{constructor:function(b){Ext.apply(this,b);var d=this.et;var c=this.grid;var a=this.record;uft.bill.RowContextMenu.superclass.constructor.call(this,{items:[{text:"增加自定义项目...",scope:this,handler:function(){d.addNullField(c);}},{text:"增加自定义项目到新页签...",scope:this,handler:function(){var e=new uft.bill.NewTabWin({et:d});e.show();e.on("ok",function(g,f){d.addNullFieldToNewTab(this.grid,f);},this);}},"-",{text:"删除项目",scope:this,handler:function(){c.getStore().remove(a);}},{text:"移动项目到...",scope:this,handler:function(){var e=d.getTabs(c);if(e.length==1){uft.Utils.showWarnMsg("不能选择同一个页签！");return;}var f=new uft.bill.TabWin({et:d,grid:c});f.show();f.on("ok",function(h,g){d.moveFieldTo(c,a,g);},this);}},{text:"移动项目到新页签...",scope:this,handler:function(){var e=new uft.bill.NewTabWin({et:d});e.show();e.on("ok",function(g,f){d.moveFieldToNewTab(c,a,f);},this);}},"-",{text:"项目重新排序...",scope:this,handler:function(){var e=new uft.bill.OrderWin({et:d,grid:c});e.on("ok",function(g,f){d.reOrderField(c,f);},this);e.show();}},{text:"项目结构调整...",scope:this,handler:function(){var e=new uft.bill.AdjustWin({et:d,grid:c});e.show();}},{text:"删除页签...",scope:this,handler:function(){Ext.Msg.confirm("确认","确定删除吗？",function(e){if(e=="yes"){d.deleteTab(c);}},this);}}]});}});uft.bill.TableContextMenu=Ext.extend(Ext.menu.Menu,{constructor:function(a){Ext.apply(this,a);var b=this.et;uft.bill.TableContextMenu.superclass.constructor.call(this,{items:[{text:"添加到表头...",scope:this,handler:function(){var c=this.getTableName();b.addTableTo(null,c,true);}},{text:"添加到表体...",scope:this,handler:function(){var c=this.getTableName();b.addTableTo(null,c,false);}},"-",{text:"增加到表头新页签...",scope:this,handler:function(){var c=this.getTableName();var d=new uft.bill.NewTabWin({et:b,tabcode:c});d.show();d.on("ok",function(f,e){e.pos=0;e.tabindex=b.getNewTabIndex(true);b.addTableTo(null,c,true,true,e);},this);}},{text:"增加到表体新页签...",scope:this,handler:function(){var c=this.getTableName();var d=new uft.bill.NewTabWin({et:b,tabcode:c});d.show();d.on("ok",function(f,e){e.pos=1;e.tabindex=b.getNewTabIndex(false);b.addTableTo(null,c,false,true,e);},this);}}]});},getTableName:function(){return Ext.getCmp(this.et.headerTableMultiSelectID).getValue();}});uft.bill.FieldContextMenu=Ext.extend(Ext.menu.Menu,{constructor:function(a){Ext.apply(this,a);var b=this.et;uft.bill.FieldContextMenu.superclass.constructor.call(this,{items:[{text:"添加到表头...",scope:this,handler:function(){var d=this.getTableName();var c=this.getFields();b.addFieldTo(null,d,c,true);}},{text:"添加到表体...",scope:this,handler:function(){var d=this.getTableName();var c=this.getFields();b.addFieldTo(null,d,c,false);}},"-",{text:"增加到表头新页签...",scope:this,handler:function(){var c=new uft.bill.NewTabWin({et:b});c.show();c.on("ok",function(g,f){var e=this.getTableName();var d=this.getFields();f.pos=0;f.tabindex=b.getNewTabIndex(true);b.addFieldTo(null,e,d,true,true,f);},this);}},{text:"增加到表体新页签...",scope:this,handler:function(){var c=new uft.bill.NewTabWin({et:b});c.show();c.on("ok",function(g,f){var e=this.getTableName();var d=this.getFields();f.pos=1;f.tabindex=b.getNewTabIndex(false);b.addFieldTo(null,e,d,false,true,f);},this);}}]});},getTableName:function(){return Ext.getCmp(this.et.headerTableMultiSelectID).getValue();},getFields:function(){var a=Ext.getCmp(this.et.headerTableFieldMultiSelectID).view.getSelectedRecords();return a[0].data;}});Ext.namespace("uft.bill");uft.bill.EditTemplet=Ext.extend(Ext.Window,{pk_billtemplet:null,pk_billtypecode:null,headerTableMultiSelectID:"b_headerTable",headerTableFieldMultiSelectID:"b_headerTableField",panelID:"editTempletPanel",templetDataChange:false,constructor:function(c){Ext.apply(this,c);if(!this.templetDesc){this.templetDesc={};}if(!this.tableFieldMap){this.tableFieldMap={};}if(!this.fieldLengthMap){this.fieldLengthMap={};}this.pk_billtemplet=this.templetData.pk_billtemplet;this.pk_billtypecode=this.templetData.pk_billtypecode;if(this.pk_billtemplet){var e=this.templetData.TEMPLET;for(var d=0;d<e.length;d++){if(this.pk_billtemplet==e[d].pk_billtemplet){Ext.apply(this.templetDesc,e[d]);break;}}}this.toolbar=new Ext.Toolbar({plugins:new Ext.ux.ToolbarKeyMap(),items:[{text:"保存模板",scope:this,tooltip:"Ctrl+S",iconCls:"btnSave",keyBinding:{key:"s",ctrl:true},handler:this.saveBillTemplet},{text:"生成查询模板",tooltip:"Ctrl+Q",keyBinding:{key:"q",ctrl:true},scope:this,handler:this.genQueryTemplet},{text:"生成报表模板",tooltip:"Ctrl+R",keyBinding:{key:"r",ctrl:true},scope:this,handler:this.genReportTemplet},{text:"返回",iconCls:"btnBack",scope:this,tooltip:"ESC",handler:function(){if(this.templetDataChange){Ext.Msg.confirm("确认","模板数据已改变，是否保存？",function(f){if(f=="yes"){this.saveBillTemplet();}else{this.close();}},this);}else{this.close();}}}]});this.headerPanel=new Ext.Panel({region:"center",layout:"fit",split:true,items:[]});this.bodyPanel=new Ext.Panel({layout:"fit",region:"south",height:230,split:true,collapseMode:"mini",items:[]});var b=new Ext.Panel({region:"center",layout:"border",border:false,items:[this.headerPanel,this.bodyPanel]});this.tableTab=new Ext.TabPanel({region:"north",height:320,activeTab:0,items:[{title:"表",layout:"fit",items:[new Ext.ux.form.MultiSelect({id:this.headerTableMultiSelectID,displayField:"text",valueField:"value",style:"height:100%;",draggable:true,store:new Ext.data.JsonStore({root:"records",fields:["value","text"]})})]},{id:"fieldTab",title:"字段",layout:"fit",items:[new Ext.ux.form.MultiSelect({id:this.headerTableFieldMultiSelectID,displayField:"text",valueField:"value",height:300,draggable:true,store:new Ext.data.JsonStore({root:"records",fields:["value","text"]})})]}]});this.tableTab.on("tabchange",function(k,g){if(g.id=="fieldTab"){var h=Ext.getCmp(this.headerTableMultiSelectID).getValue();if(h){var i=h.indexOf(",");if(i!=-1){h=h.substring(0,i);}var f=this.tableFieldMap[h];if(f){Ext.getCmp(this.headerTableFieldMultiSelectID).setRecord(f);}else{var j=function(l){if(l&&l.append){Ext.apply(this.fieldLengthMap,l.append);}if(l&&l.datas){Ext.getCmp(this.headerTableFieldMultiSelectID).setRecord(l.datas);this.tableFieldMap[h]=l.datas;}};this.loadTableFields(h,j,this);}}}},this);this.tabPropertiesGrid=new Ext.grid.PropertyGrid({fields:[{id:"tabcode",header:this.getNotEditHeader("页签编码"),editable:false},{id:"tabname",header:"页签名称"},{id:"tabindex",header:"显示顺序"},{id:"pos",header:this.getNotEditHeader("页签显示位置"),editable:false,renderer:this.comboRenderer,editor:new uft.extend.form.LocalCombox({store:new Ext.data.SimpleStore({fields:["text","value"],data:[["表头",0],["表体",1],["表尾",2]]})})}]});this.tabPropertiesGrid.on("afteredit",function(j){this.templetDataChange=true;if(j.record.id=="tabname"){var g=j.grid;var f=g.store.getById("tabcode").get("value");var k=g.store.getById("tabname").get("value");this.updateTabinfo(f,"tabname",k);var i=Ext.getCmp(f);if(i){i.setTitle(k);}}else{if(j.record.id=="tabindex"){var g=j.grid;var f=g.store.getById("tabcode").get("value");var h=g.store.getById("tabindex").get("value");this.updateTabinfo(f,"tabindex",h);}}},this);this.tabPropertiesTab=new Ext.TabPanel({split:true,activeTab:0,items:[{title:"页签属性",layout:"fit",items:[this.tabPropertiesGrid]}]});this.propertyTab=new Ext.Panel({region:"center",layout:"fit",border:false,items:[this.tabPropertiesTab]});this.eastPanel=new Ext.Panel({region:"east",width:200,border:false,split:true,layout:"border",collapseMode:"mini",items:[this.tableTab,this.propertyTab]});var a=new Ext.Panel({tbar:this.toolbar,layout:"border",border:false,items:[b,this.eastPanel]});uft.bill.EditTemplet.superclass.constructor.call(this,{id:this.panelID,title:"模板初始化",width:1000,height:550,layout:"fit",shim:true,closable:false,maximizable:true,border:false,modal:true,items:[a]});},afterRender:function(){uft.bill.EditTemplet.superclass.afterRender.call(this);if(this.templetData){var a=[];if(this.templetData.HEADERTABLE){a.push(this.templetData.HEADERTABLE);}if(this.templetData.BODYTABLE){a=a.concat(this.templetData.BODYTABLE);}Ext.getCmp(this.headerTableMultiSelectID).setRecord(a);delete this.templetData;}this.onAppReady();},onAppReady:function(){this.initDD();var b=Ext.getCmp(this.headerTableMultiSelectID);b.view.select(0);b.view.on("contextmenu",function(d,c,f,g){g.preventDefault();var h=new uft.bill.TableContextMenu({et:this});h.showAt(g.getXY());},this);var a=Ext.getCmp(this.headerTableFieldMultiSelectID);a.on("_set",function(){a.view.on("contextmenu",function(d,c,f,g){g.preventDefault();var h=new uft.bill.FieldContextMenu({et:this});h.showAt(g.getXY());},this);},this);this.getTempletMap();if(this.pk_billtemplet){this.loadTempletDesc();}},getTempletMap:function(){var a=Utils.doSyncRequest("getTempletMap.json",{funCode:"t015",tabCode:"nw_billtemplet_b"},"POST");if(!a||!a.data){uft.Utils.showErrorMsg("没有模板数据，funCode：t015,tabcode:nw_billtemplet_b！");return false;}this.R=a.data.records;this.C=a.data.columns;this.params=a.data.params;},loadTempletDesc:function(){var a=Ext.apply({},this.params);Ext.apply(a,{pk_billtemplet:this.pk_billtemplet});uft.Utils.doAjax({scope:this,params:a,url:"loadTempletDesc.json",isTip:false,success:function(b){if(b&&b.data){this.templetDesc=Ext.apply(this.templetDesc,b.data);this.buildTemplet();}}});},buildTemplet:function(){var g=this.templetDesc;var c=g.B;var h=g.T;var e=g.headerTabAry;var k=g.bodyTabAry;if(e.length>0){var j=this.createTab();for(var f=0;f<e.length;f++){var b=h[e[f]];var a=this.buildTempletGrid(true,b.tabcode);a.tabcode=b.tabcode;a.title=b.tabname;j.add(a);a.addRecords(c[e[f]]);}this.headerPanel.add(j);this.headerPanel.doLayout();this.setTabProperty(h[e[0]]);}if(k.length>0){var l=this.createTab();for(var f=0;f<k.length;f++){var b=h[k[f]];var a=this.buildTempletGrid(false,b.tabcode);a.tabcode=b.tabcode;a.title=b.tabname;l.add(a);a.addRecords(c[k[f]]);}this.bodyPanel.add(l);this.bodyPanel.doLayout();}},getNotEditHeader:function(a){return'<span class="uft-grid-header-column-not-edit">'+a+"</span>";},comboRenderer:function(f,d,e){var c=e.data.field;var b=c.editor.store;var a=b.query("value",new RegExp("^"+f+"$","i")).itemAt(0);if(a){return a.get("text");}return"";},loadTableFields:function(a,c,b){uft.Utils.doAjax({scope:b,params:{tableName:a},url:"loadTableFields.json",isTip:false,success:c});},isTable:function(a){if(a.ms&&a.ms.id==this.headerTableMultiSelectID){return true;}return false;},isField:function(a){if(a.ms&&a.ms.id==this.headerTableFieldMultiSelectID){return true;}return false;},buildTempletGrid:function(g,a){var f=uft.Utils.clone(this.R);var h=uft.Utils.clone(this.C);for(var d=0;d<h.length;d++){if(g===false){if(h[d].dataIndex=="metadataproperty"){h[d].hidden=true;}else{if(h[d].dataIndex=="width"){f[d].value=100;}}}if(h[d].dataIndex=="loadformula"||h[d].dataIndex=="editformula"){var e=h[d].editor;e.tooltip=="请输入";}}var b=new Ext.ux.dd.GridDragDropRowOrder();var c=new uft.extend.grid.EditorGrid({border:false,id:a,pkFieldName:"pk_billtemplet_b",isAddBbar:false,sortable:false,plugins:[b],sm:new Ext.grid.RowSelectionModel(),recordType:f,columns:h});b.on("afterrowmove",function(p,q,o,n){var j=c.getStore(),m=j.getCount();for(var k=0;k<m;k++){var l=j.getAt(k);l.set("showorder",k+1);}},this);c.on("rowcontextmenu",function(j,m,k){k.preventDefault();var i=j.getStore().getAt(m);j.getSelectionModel().selectRow(m);var l=new uft.bill.RowContextMenu({et:this,grid:j,record:i});l.showAt(k.getXY());},this);c.on("contextmenu",function(i){i.preventDefault();var j=new uft.bill.GridContextMenu({et:this,grid:c});j.showAt(i.getXY());},this);c.on("render",function(i){i.body.on("click",function(){var l=c.tabcode;var m=this.templetDesc;var k=m.T;if(k){var j=k[l];this.setTabProperty(j);}},this);},this);c.on("afteredit",function(j){this.templetDataChange=true;if(j.field=="itemkey"){var k=this.getTabPanel(j.grid);var i=this.hasColumn(j.grid,j.value,k[1],true,j.record.id);if(i){uft.Utils.showWarnMsg("项目主键已存在，请换一个！");j.record.set("itemkey",null);return;}}else{if(j.field=="datatype"){if(String(j.value)=="9"){j.record.set("reftype","(100,50)");}else{j.record.set("reftype","");}}}},this);c.on("beforeedit",function(l){var j=uft.Utils.getColumn(l.grid,l.field);if(l.field=="reftype"){var k=l.record;var i=String(k.get("datatype"));if(i=="2"){if(!(j.editor instanceof uft.bill.DecimaltypeField)){j.setEditor(new uft.bill.DecimaltypeField());}}else{if(i=="5"){if(!(j.editor instanceof uft.bill.ReftypeField)){j.setEditor(new uft.bill.ReftypeField());}}else{if(i=="6"){if(!(j.editor instanceof uft.bill.SelecttypeField)){j.setEditor(new uft.bill.SelecttypeField());}}else{if(i=="9"||i=="11"){j.setEditor(new Ext.form.TextField());}else{return false;}}}}}},this);return c;},createTab:function(b){var a=[];if(b){a.push(b);}var c=new Ext.TabPanel({activeTab:0,border:false,items:a});c.on("tabchange",function(e,d){if(d&&d.tabcode){this.changeTabProperty(d.tabcode);}},this);return c;},changeTabProperty:function(c){var e=this.templetDesc;var b=e.T;if(b){var a=b[c];this.setTabProperty(a);}},removeTabInfo:function(a,b){var c=this.templetDesc;if(!c.T){return;}if(!c.DT){c.DT={};}c.DT[a]=c.T[a];c.T[a]=null;delete c.T[a];if(b){if(!c.headerTabAry){return;}c.headerTabAry.remove(a);}else{if(!c.bodyTabAry){return;}c.bodyTabAry.remove(a);}},updateTabinfo:function(b,d,c){var e=this.templetDesc;if(!e.T){return;}var a=e.T[b];if(a){a[d]=c;}},setTabProperty:function(a,d,c){if(!a){return;}if(c){var f=this.templetDesc;if(!f.T){f.T={};}f.T[a.tabcode]=a;if(d){if(!f.headerTabAry){f.headerTabAry=[];}f.headerTabAry.push(a.tabcode);var e=this.headerPanel.items.items[0];e.setActiveTab(e.items.items.length-1);}else{if(!f.bodyTabAry){f.bodyTabAry=[];}f.bodyTabAry.push(a.tabcode);var e=this.bodyPanel.items.items[0];e.setActiveTab(e.items.items.length-1);}}var b=this.tabPropertiesGrid;b.setValue("tabcode",a.tabcode);b.setValue("tabname",a.tabname);b.setValue("tabindex",a.tabindex);b.setValue("pos",a.pos);},hasColumn:function(e,h,g,a,d){if(g){var b=this.headerPanel.items.items;if(b.length>0){var f=b[0].items.items;for(var c=0;c<f.length;c++){if(this._checkColumn(f[c],h,a,d)){return true;}}}}else{return this._checkColumn(e,h,a,d);}return false;},_checkColumn:function(a,d,c,f){var e=a.getStore(),j=e.getCount();for(var g=0;g<j;g++){var h=e.getAt(g);var b=h.get("itemkey");if(c){if(b==d&&h.id!=f){return true;}}else{if(b==d){return true;}}}return false;},hasTab:function(a){var c=this.templetDesc;if(c&&c.headerTabAry){for(var b=0;b<c.headerTabAry.length;b++){if(c.headerTabAry[b]==a){return true;}}}if(c&&c.bodyTabAry){for(var b=0;b<c.bodyTabAry.length;b++){if(c.bodyTabAry[b]==a){return true;}}}return false;},getTabPanel:function(c){var d=this.headerPanel.items.items[0];if(d){var a=d.items.items;for(var b=0;b<a.length;b++){if(a[b].id==c.id){return[d,true];}}}d=this.bodyPanel.items.items[0];if(d){var a=d.items.items;for(var b=0;b<a.length;b++){if(a[b].id==c.id){return[d,false];}}}return null;},getNewTabIndex:function(a){if(a){var b=this.headerPanel.items.items[0];if(!b){return 0;}return b.items.items.length;}else{var b=this.bodyPanel.items.items[0];if(!b){return 0;}return b.items.items.length;}},initDD:function(a,b){if(!a){new Ext.dd.DropTarget(this.headerPanel.body.dom,{ddGroup:"MultiselectDD",et:this,notifyDrop:function(g,f,c){var d=this.et;d.dropTo(g,f,c,null,true);return(true);}});new Ext.dd.DropTarget(this.bodyPanel.body.dom,{ddGroup:"MultiselectDD",et:this,notifyDrop:function(g,f,c){var d=this.et;d.dropTo(g,f,c,null,false);return(true);}});}else{}},dropTo:function(g,j,f,c,a){if(this.isTable(g)){var b=f.records;var k=b[0].get("value");this.addTableTo(c,k,a);}else{if(this.isField(g)){var k=Ext.getCmp(this.headerTableMultiSelectID).getValue();var b=f.records;var h=[];for(var d=0;d<b.length;d++){h.push(b[d].data);}this.addFieldTo(c,k,h,a);}}},addTableTo:function(d,c,f,g,b){var a=this.tableFieldMap[c];if(a){this.buildField(d,c,a,f,g,b);}else{var e=function(h){if(h&&h.append){Ext.apply(this.fieldLengthMap,h.append);}if(h&&h.datas){this.buildField(d,c,h.datas,f,g,b);this.tableFieldMap[c]=h.datas;}};this.loadTableFields(c,e,this);}},addFieldTo:function(d,c,a,e,f,b){this.buildField(d,c,a,e,f,b);},buildField:function(j,r,m,c,f,q){if(!j){if(f===true){j=this.buildTempletGrid(c,q.tabcode);j.tabcode=q.tabcode;j.title=q.tabname;var p;if(c){var o=this.headerPanel.items.items;if(o.length>0){p=o[0];p.add(j);}else{p=this.createTab(j);this.headerPanel.add(p);}this.headerPanel.doLayout(true);}else{var o=this.bodyPanel.items.items;if(o.length>0){p=o[0];p.add(j);}else{p=this.createTab(j);this.bodyPanel.add(p);}this.bodyPanel.doLayout(true);}this.setTabProperty(q,c,true);this.initDD(j,c);}else{if(c){var o=this.headerPanel.items.items;if(o.length>0){j=o[0].getActiveTab();}}else{var o=this.bodyPanel.items.items;if(o.length>0){j=o[0].getActiveTab();}}if(!j){var k=r;if(this.hasTab(k)){k="new";}j=this.buildTempletGrid(c,k);var q={};q.tabcode=k;q.tabname=k;q.pos=c?0:1;q.tabindex=0;j.tabcode=k;j.title=k;var n=this.createTab(j);if(c){this.headerPanel.add(n);this.headerPanel.doLayout();}else{this.bodyPanel.add(n);this.bodyPanel.doLayout();}this.setTabProperty(q,c,true);this.initDD(j,c);}}}if(!Ext.isArray(m)){m=[m];}var k=j.tabcode;var h=j.title;var g=j.getStore().getCount();for(var l=0;l<m.length;l++){var b=m[l].value;if(this.hasColumn(j,b,c)){uft.Utils.showWarnMsg("项目‘"+b+"’已存在！");}else{var e=g+l+1;if(m[l].data){Ext.apply(m[l].data,{showorder:e});j.addRow(m[l].data);}else{var d=this.fieldLengthMap[r+"_"+b];var a={itemkey:b,defaultshowname:b,inputlength:d,showorder:e,table_code:k,table_name:h,pos:c?0:1};if(b=="dr"||b=="ts"){a.showflag=0;a.listshowflag="N";a.editflag=0;if(b=="dr"){a.datatype=1;}else{if(b=="ts"){a.datatype=15;}}}j.addRow(a);}}}},addNullField:function(b){var d=this.getTabPanel(b);var c=b.getStore();var a={showorder:c.getCount()+1,table_code:b.tabcode,table_name:b.tabname};a.pos=d[1]?0:1;b.addRow(a);},addNullFieldToNewTab:function(d,a){var f=this.getTabPanel(d);var e=f[0].items.items.length;a.tabindex=e;a.pos=f[1]?0:1;var b=this.buildTempletGrid(f[1],a.tabcode);b.title=a.tabname;b.tabcode=a.tabcode;f[0].add(b);f[0].doLayout();f[0].setActiveTab(b);var c={showorder:1,table_code:a.tabcode,table_name:a.tabname};c.pos=f[1]?0:1;b.addRow(c);this.setTabProperty(a,f[1],true);},reOrderField:function(a,b){if(b&&b.length>0){var c={};var e=a.getStore(),j=e.getCount();for(var g=0;g<j;g++){var h=e.getAt(g);var d=h.get("itemkey");c[d]=h;}e.removeAll(true);e.modified=[];var f=[];for(var g=0;g<b.length;g++){var h=c[b[g]];h.set("showorder",g+1);f.push(h);}e.add(f);}},moveFieldToNewTab:function(d,a,c){var e={};e.value=a.get("itemkey");e.text=a.get("defaultshowname");e.data=a.data;d.getStore().remove(a);var b=Ext.getCmp(this.headerTableMultiSelectID).getValue();c.pos=0;c.tabindex=this.getNewTabIndex(true);var f=this.getTabPanel(d);this.addFieldTo(null,b,[e],f[1],true,c);},moveFieldTo:function(a,f,c){var l={};l.value=f.get("itemkey");l.text=f.get("defaultshowname");l.data=f.data;l.data.table_code=c;var g=this.templetDesc;var h=g.T;if(h){var m=h[c];l.data.table_name=m.tabname;}a.getStore().remove(f);var b;var k=this.getTabPanel(a);var j=k[0].items.items;for(var e=0;e<j.length;e++){if(j[e].tabcode==c){b=j[e];break;}}this.addFieldTo(b,null,[l],k[1]);},getTabs:function(a){var b=this.getTabPanel(a);return b[0].items.items;},deleteTab:function(c){var b=c.tabcode;var d=this.getTabPanel(c);this.removeTabInfo(b,d[1]);var a=d[0].items.items;if(a.length==1){if(d[1]){this.headerPanel.remove(d[0]);this.headerPanel.doLayout();}else{this.bodyPanel.remove(d[0]);this.bodyPanel.doLayout();}}else{d[0].remove(c,true);d[0].doLayout();}},saveBillTemplet:function(){var a=new uft.bill.SaveBillWin({et:Ext.getCmp(this.panelID)});a.on("ok",function(c,b){var e=this.getAppParams(b);if(e!==false){var d={};d[uft.jf.Constants.APP_POST_DATA]=Ext.encode(e);d.pk_billtypecode=this.pk_billtypecode;uft.Utils.doAjax({scope:this,url:"saveBillTemplet.json",actionType:"保存",params:d,success:function(f){this.templetDataChange=false;if(f){if(f.data){var j=this.getAllGridAry();var l=this.templetDesc=f.data;this.pk_billtemplet=l.pk_billtemplet;this.pk_billtypecode=l.pk_billtypecode;var k=l.B,h;for(h in k){for(var g=0;g<j.length;g++){if(h==j[g].tabcode){this.updateGrid(j[g],k[h]);}}}}}this.fireEvent("save",this,f);}});}},this);a.show();},updateGrid:function(a,c){var b=a.getStore(),h=b.getCount();for(var e=0;e<c.length;e++){var g=c[e];for(var d=0;d<h;d++){var f=b.getAt(d);if(f.get("itemkey")==g.itemkey){f.beginEdit();var k;for(k in g){f.set(k,g[k]);}f.endEdit();break;}}}},getAllGridAry:function(){var b=[];var a=this.headerPanel.items.items;if(a&&a.length>0){b=b.concat(a[0].items.items);}a=this.bodyPanel.items.items;if(a&&a.length>0){b=b.concat(a[0].items.items);}return b;},getAppParams:function(n){var m={};var b={};b.pk_billtypecode=this.pk_billtypecode;b.pk_billtemplet=this.pk_billtemplet;b.bill_templetcaption=this.templetDesc.bill_templetcaption=n.bill_templetcaption;b.ts=this.templetDesc.ts;b.nodecode=this.templetDesc.nodecode=n.nodecode;m[uft.jf.Constants.HEADER]=b;var e=this.getAllGridAry();if(e.length==0){uft.Utils.showWarnMsg("没有模板数据，不能保存！");return false;}var g={};var f={"delete":[],update:[]};for(var h=0;h<e.length;h++){if(!e[h].isValid()){errors=e[h].getAllErrors();uft.Utils.showWarnMsg(Utils.arrayToString(errors,""));return false;}var p=e[h].getModifyValue();f["delete"]=f["delete"].concat(p["delete"]);f.update=f.update.concat(p.update);}g.nw_billtemplet_b=f;var j=this.templetDesc,k=j.T,a=j.DT,o=[],c=[],l;for(l in k){o.push(k[l]);}for(l in a){c.push(a[l]);}g.nw_billtemplet_t={"delete":c,update:o};m[uft.jf.Constants.BODY]=g;return m;},getGridModifyData:function(b){var c={};for(var a=0;a<b.length;a++){if(!b[a].isValid()){errors=b[a].getAllErrors();uft.Utils.showWarnMsg(Utils.arrayToString(errors,""));return false;}c[b[a].tabcode]=b[a].getModifyValue();}return c;},genQueryTemplet:function(){if(!this.pk_billtemplet){uft.Utils.showWarnMsg("请先保存模板！");return false;}var a=new uft.bill.BuildQueryTempletWin();a.on("ok",function(c,b){uft.Utils.doAjax({scope:this,url:"buildQueryTemplet.json",actionType:"生成查询模板",params:Ext.apply(b,{pk_billtemplet:this.pk_billtemplet}),success:function(d){}});},this);a.show();},genReportTemplet:function(){if(!this.pk_billtemplet){uft.Utils.showWarnMsg("请先保存模板！");return false;}var a=new uft.bill.BuildReportTempletWin();a.on("ok",function(c,b){uft.Utils.doAjax({scope:this,url:"buildReportTemplet.json",actionType:"生成报表模板",params:Ext.apply(b,{pk_billtemplet:this.pk_billtemplet}),success:function(d){}});},this);a.show();}});Ext.namespace("uft.bill");uft.bill.BillTemplet=Ext.extend(Ext.Panel,{clientWidth:document.documentElement.clientWidth,clientHeight:document.documentElement.clientHeight,headerFieldHeight:30,headerTableHeight:200,leftButtonWidth:50,rightButtonWidth:70,constructor:function(c){Ext.apply(this,c);this.bodyTableHeight=this.clientHeight-this.headerTableHeight-this.headerFieldHeight;this.tableField=new Ext.ux.form.MultiSelect({height:this.clientHeight-this.headerFieldHeight,width:this.clientWidth/4,legend:"数据库表",displayField:"text",valueField:"value",store:new Ext.data.JsonStore({url:"loadUserTable.json",root:"records",fields:["value","text"]})});this.headerTableField=new Ext.ux.form.MultiSelect({height:this.headerTableHeight,width:this.clientWidth/4-this.leftButtonWidth-2,legend:"主表",displayField:"text",valueField:"value",store:new Ext.data.JsonStore({url:"loadHeaderTable.json",root:"records",fields:["value","text"]})});this.bodyTableField=new Ext.ux.form.MultiSelect({height:this.bodyTableHeight,width:this.clientWidth/4-this.leftButtonWidth-2,legend:"子表",displayField:"text",valueField:"value",store:new Ext.data.JsonStore({url:"loadBodyTable.json",root:"records",fields:["value","text"]})});this.filterField=new uft.extend.form.FilterField({emptyText:"表前缀过滤",enableKeyEvents:true,scope:this,fn:this.onFilter});var b=new Ext.Panel({width:this.clientWidth/2,region:"west",layout:"table",layoutConfig:{columns:2},items:[{padding:"3px 0 0 5px",height:this.headerFieldHeight,colspan:2,border:false,items:[this.filterField]},{border:false,layout:"fit",rowspan:2,items:[this.tableField]},{height:this.headerTableHeight,border:false,layout:"fit",items:[{border:false,width:this.clientWidth/4,height:this.headerTableHeight,layout:"border",items:[{padding:"8px 0 0 5px",border:false,region:"west",baseCls:"x-plain",xtype:"buttongroup",width:this.leftButtonWidth,layoutConfig:{columns:1},items:[{xtype:"button",width:this.leftButtonWidth-10,text:">",scope:this,handler:this.addToHeaderTable},{xtype:"button",width:this.leftButtonWidth-10,text:"<",scope:this,handler:this.removeFromHeaderTable}]},{border:false,region:"center",layout:"fit",items:[this.headerTableField]}]}]},{height:this.bodyTableHeight,border:false,layout:"fit",items:[{border:false,width:this.clientWidth/4,height:this.bodyTableHeight,layout:"border",items:[{border:false,padding:"8px 0 0 5px",region:"west",baseCls:"x-plain",xtype:"buttongroup",width:this.leftButtonWidth,layoutConfig:{columns:1},items:[{xtype:"button",width:this.leftButtonWidth-10,text:">",scope:this,handler:this.addToBodyTable},{xtype:"button",width:this.leftButtonWidth-10,text:"<",scope:this,handler:this.removeFromBodyTable}]},{border:false,region:"center",layout:"fit",items:[this.bodyTableField]}]}]}]});this.billtypecodeField=new uft.extend.form.HeaderRefField({fieldLabel:"单据模板编码(10个字符内)",refName:"单据模板-web",xtype:"headerreffield",id:"pk_billtypecode",maxLength:10,refWindow:{model:1,leafflag:false,gridDataUrl:ctxPath+"/ref/common/bt/load4Grid.json",extGridColumnDescns:[{type:"string",width:120,dataIndex:"pk_billtemplet",sortable:true,xtype:"gridcolumn",hidden:true},{header:"模板编码",type:"string",width:120,dataIndex:"pk_billtypecode",xtype:"gridcolumn"},{header:"模板类型",type:"string",width:120,dataIndex:"bill_templetcaption",xtype:"gridcolumn"}]},pkField:"pk_billtypecode",codeField:"pk_billtypecode",nameField:"pk_billtypecode",showCodeOnFocus:true,isFocusAfterSubmit:true,showCodeOnBlur:true,getByPkUrl:ctxPath+"/ref/common/bt/getByPk.do",getByCodeUrl:ctxPath+"/ref/common/bt/getByCode.do"});this.billtypecodeField.on("specialkey",function(d,g){if(g.getKey()==13){if(Ext.isGecko){}else{g.keyCode=9;g.browserEvent.keyCode=9;}}},this);this.billtypecodeField.on("change",function(f,e,d){uft.Utils.doAjax({scope:this,params:{pk_billtypecode:e},url:"loadTempletData.json",isTip:false,success:function(g){if(g&&g.data){var h=this.templetData=g.data;if(h.HEADERTABLE){this.headerTableField.setRecord([h.HEADERTABLE]);}else{this.headerTableField.setRecord(null);}if(h.BODYTABLE&&h.BODYTABLE.length>0){this.bodyTableField.setRecord(h.BODYTABLE);}else{this.bodyTableField.setRecord(null);}if(h.TEMPLET&&h.TEMPLET.length>0){this.templetField.setRecord(h.TEMPLET);this.templetField.select(0);}}else{this.templetData=null;this.headerTableField.setRecord(null);this.bodyTableField.setRecord(null);this.templetField.setRecord(null);this.templetField.select(0);}Ext.getCmp("btn_add").enable();}});},this);this.templetField=new Ext.ux.form.MultiSelect({height:this.clientHeight,width:this.clientWidth/2-this.rightButtonWidth,legend:"已定义模板",displayField:"text",valueField:"value",store:new Ext.data.JsonStore({root:"records",fields:["value","text"]})});this.templetField.on("_select",function(h,f){var g=this.templetField.getValue();var i=Ext.getCmp("btn_edit");var e=Ext.getCmp("btn_copy");var d=Ext.getCmp("btn_del");if(g){e.enable();i.enable();d.enable();}else{e.disable();i.disable();d.disable();}},this);var a=new Ext.Panel({region:"center",autoHeight:true,layout:"table",layoutConfig:{columns:2},items:[{border:false,padding:"3px 0 0 5px",height:this.headerFieldHeight,layout:"form",labelWidth:150,colspan:2,items:[this.billtypecodeField]},{border:false,layout:"fit",items:[this.templetField]},{border:false,padding:"8px 0 0 5px",baseCls:"x-plain",xtype:"buttongroup",width:this.rightButtonWidth,layoutConfig:{columns:1},items:[{id:"btn_add",xtype:"button",width:this.rightButtonWidth-10,cls:"x-btn-padd",text:"新建",disabled:true,scope:this,handler:this.addTemplet},{id:"btn_edit",xtype:"button",width:this.rightButtonWidth-10,cls:"x-btn-padd",text:"修改",disabled:true,scope:this,handler:this.editTemplet},{id:"btn_copy",xtype:"button",width:this.rightButtonWidth-10,cls:"x-btn-padd",text:"复制",disabled:true,scope:this,handler:this.copyTemplet},{id:"btn_del",xtype:"button",width:this.rightButtonWidth-10,cls:"x-btn-padd",text:"删除",disabled:true,scope:this,handler:this.deleteTemplet}]}]});uft.bill.BillTemplet.superclass.constructor.call(this,{layout:"border",border:false,padding:"0 0 2px 0",renderTo:document.body,height:this.clientHeight,items:[b,a]});},onFilter:function(){var a=this.tableField.store;var b={};b.params={keyword:this.filterField.getValue()};a.load(b);},fromTo:function(j,b){var h=j.view.getSelectedIndexes();var d=[],g;if(h.length>0){for(var f=0;f<h.length;f++){g=j.view.store.getAt(h[f]);d.push(g);}for(var f=0;f<d.length;f++){var e=d[f].data;var c=e[j.valueField];var a=b.view.store.getById(c);if(a){continue;}g=new Ext.data.Record(e,c);b.view.store.add(g);h.push((b.view.store.getCount()-1));}}b.view.refresh();b.view.clearSelections();b.view.select(h);},addToHeaderTable:function(){var a=this.headerTableField.view.store.getCount();if(a>0){uft.Utils.showWarnMsg("不支持多主表！");return;}this.fromTo(this.tableField,this.headerTableField);},removeFromHeaderTable:function(){var c=this.headerTableField.view.getSelectedIndexes();for(var b=0;b<c.length;b++){var a=this.headerTableField.view.store.getAt(c[b]);this.headerTableField.view.store.remove(a);}},addToBodyTable:function(){this.fromTo(this.tableField,this.bodyTableField);},removeFromBodyTable:function(){var c=this.bodyTableField.view.getSelectedIndexes();for(var b=0;b<c.length;b++){var a=this.bodyTableField.view.store.getAt(c[b]);this.bodyTableField.view.store.remove(a);}},addTemplet:function(){var b=this.getTempletData();var a=new uft.bill.EditTemplet({templetData:b});a.on("close",function(f){var h=f.templetDesc;var e=h.pk_billtemplet;if(h&&e){var g=h.pk_billtypecode+" "+h.bill_templetcaption;this.templetField.addRecord([{value:e,text:g}]);var i=Ext.getCmp("btn_edit");var d=Ext.getCmp("btn_copy");var c=Ext.getCmp("btn_del");i.enable();d.enable();c.enable();}},this);a.on("save",function(d,c){if(c&&c.append){this.templetData=c.append;}},this);a.show();},editTemplet:function(){var a=this.templetField.getValue();if(a){var b=this.getTempletData();b.pk_billtemplet=a;new uft.bill.EditTemplet({templetData:b}).show();}else{uft.Utils.showWarnMsg("请先选择一行记录！");return;}},copyTemplet:function(){var f=this.templetField.getValue();if(f){var h=this.getTempletData();var e=h.pk_billtypecode;var b=h.TEMPLET,a="",d="";for(var c=0;c<b.length;c++){if(f==b[c].pk_billtemplet){a=b[c].bill_templetcaption;d=b[c].nodecode;break;}}var g=new uft.bill.CopyBillWin({bill_templetcaption:a,nodecode:d});g.show();g.on("ok",function(j,i){uft.Utils.doAjax({scope:this,method:"POST",url:"copyBillTemplet.json",actionType:"复制模板",params:{pk_billtypecode:e,pk_billtemplet:f,bill_templetcaption:i.bill_templetcaption,nodecode:i.nodecode},success:function(k){if(k){if(k.data){var m=k.data,l=m.pk_billtemplet;var n=m.pk_billtypecode+" "+m.bill_templetcaption;this.templetField.addRecord([{value:l,text:n}]);}if(k.append){this.templetData=k.append;}}}});},this);}else{uft.Utils.showWarnMsg("请先选择一行记录！");return;}},deleteTemplet:function(){var a=this.templetField.getValue();if(a){Ext.Msg.confirm("确认","确定要删除模板吗？",function(b){if(b=="yes"){uft.Utils.doAjax({scope:this,method:"GET",url:"deleteBillTemplet.json",actionType:"删除模板",params:{pk_billtemplet:a},success:function(c){this.templetField.removeRecord([a]);}});}},this);}else{uft.Utils.showWarnMsg("请先选择一行记录！");return;}},getTempletData:function(){var e=Ext.apply({},this.templetData);var d=this.headerTableField.store;if(d&&d.getCount()>0){e.HEADERTABLE=d.getAt(0).data;}var a=[];d=this.bodyTableField.store;if(d&&d.getCount()>0){for(var b=0;b<d.getCount();b++){a.push(d.getAt(b).data);}}e.BODYTABLE=a;if(!this.templetData){e.pk_billtypecode=this.billtypecodeField.getValue();e.TEMPLET=[];var d=this.templetField.store,c=d.getCount();for(var b=0;b<c;b++){e.TEMPLET.push(d.getAt(b));}}if(e.pk_billtemplet){delete e.pk_billtemplet;}this.templetData=e;return e;}});